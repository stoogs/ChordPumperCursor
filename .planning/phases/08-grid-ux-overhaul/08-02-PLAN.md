---
phase: 08-grid-ux-overhaul
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/engine/MorphEngine.h
  - src/engine/MorphEngine.cpp
  - src/midi/ChromaticPalette.h
  - src/PersistentState.h
  - src/PersistentState.cpp
  - src/ui/GridPanel.h
  - src/ui/GridPanel.cpp
  - src/ui/PluginEditor.cpp
autonomous: true
requirements: []

must_haves:
  truths:
    - "Grid displays 8×8 (64 pads) with 8 columns and 8 rows"
    - "Grid shows 64 chord suggestions after morph"
    - "Chromatic palette shows 64 chords including 7th chord types on initial load"
    - "Loading a v1 state (32 chords) into v2 code fills remaining 32 pads from palette defaults"
    - "Plugin window height is 1200px to accommodate 8 rows at current pad size"
  artifacts:
    - path: "src/engine/MorphEngine.h"
      provides: "64-element ScoredChord array return type"
      contains: "std::array<ScoredChord, 64>"
    - path: "src/midi/ChromaticPalette.h"
      provides: "64-chord palette with 7th chords"
      contains: "std::array<Chord, 64>"
    - path: "src/PersistentState.h"
      provides: "64-element grid arrays"
      contains: "std::array<Chord, 64>"
    - path: "src/PersistentState.cpp"
      provides: "Version 2 state with v1 backward migration"
      contains: "kCurrentStateVersion = 2"
  key_links:
    - from: "src/engine/MorphEngine.cpp"
      to: "src/ui/GridPanel.cpp"
      via: "morph returns 64-element array consumed by morphTo"
      pattern: "std::array<ScoredChord, 64>"
    - from: "src/PersistentState.cpp"
      to: "src/midi/ChromaticPalette.h"
      via: "v1→v2 migration fills indices 32-63 from chromaticPalette"
      pattern: "chromaticPalette"
    - from: "src/ui/GridPanel.cpp"
      to: "src/PersistentState.h"
      via: "All loops iterate to 64 matching state array sizes"
      pattern: "i < 64"
---

<objective>
Expand the grid from 8×4 (32 pads) to 8×8 (64 pads), with MorphEngine producing 64 suggestions, palette covering 7th chord types, and backward-compatible state persistence.

Purpose: Double the exploration surface — 64 pads show more harmonic options including 7th chords, making the grid a richer composition tool.
Output: 8×8 grid visible in plugin, 64-chord morph results, 64-chord palette, v2 state format with v1 migration.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-grid-ux-overhaul/08-RESEARCH.md
@.planning/phases/08-grid-ux-overhaul/08-01-SUMMARY.md
@src/engine/MorphEngine.h
@src/engine/MorphEngine.cpp
@src/midi/ChromaticPalette.h
@src/PersistentState.h
@src/PersistentState.cpp
@src/ui/GridPanel.h
@src/ui/GridPanel.cpp
@src/ui/PluginEditor.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand MorphEngine to 64 results and ChromaticPalette to 64 chords</name>
  <files>src/engine/MorphEngine.h, src/engine/MorphEngine.cpp, src/midi/ChromaticPalette.h</files>
  <action>
**MorphEngine.h:**
- Change the return type of `morph`:
  ```cpp
  std::array<ScoredChord, 64> morph(const Chord& reference,
                                     const std::vector<int>& currentVoicing) const;
  ```

**MorphEngine.cpp — morph() method:**
- Change the function signature to return `std::array<ScoredChord, 64>`.
- Change `size_t poolSize = std::min(pool.size(), size_t(40));` → `size_t(72)` to widen the pool.
- Change `constexpr size_t kFinal = 32;` → `constexpr size_t kFinal = 64;`
- In the variety post-filter, change the minimum per category from `2` to `4`:
  - `while (catCount[...] < 2)` → `while (catCount[...] < 4)`
  - `if (catCount[...] > 2 &&` → `if (catCount[...] > 4 &&`
- Change `std::array<ScoredChord, 32> result{};` → `std::array<ScoredChord, 64> result{};`
- **Score normalization:** After computing `composite`, normalize by dividing by the weight sum so scores span [0, 1] instead of [0, 0.90]:
  ```cpp
  float weightSum = weights.diatonic + weights.commonTones + weights.voiceLeading;
  float composite = (weights.diatonic * ds +
                     weights.commonTones * ctScore +
                     weights.voiceLeading * vlScore);
  if (weightSum > 0.0f)
      composite /= weightSum;
  ```
  Place this where `composite` is currently computed (around line 108). The `weightSum` avoids division by zero.

**ChromaticPalette.h:**
- Change return type from `std::array<Chord, 32>` to `std::array<Chord, 64>`.
- Keep existing rows 0–3 (32 chords: Major, Minor, Diminished, Augmented).
- Add 4 new rows (32 chords) for 7th chord types:
  ```cpp
  // Row 4: Dominant 7th (8 common roots)
  {C, CT::Dom7}, {D, CT::Dom7}, {E, CT::Dom7}, {F, CT::Dom7},
  {G, CT::Dom7}, {A, CT::Dom7}, {Bb, CT::Dom7}, {B, CT::Dom7},
  // Row 5: Minor 7th
  {C, CT::Min7}, {D, CT::Min7}, {E, CT::Min7}, {F, CT::Min7},
  {G, CT::Min7}, {A, CT::Min7}, {Bb, CT::Min7}, {B, CT::Min7},
  // Row 6: Major 7th
  {C, CT::Maj7}, {D, CT::Maj7}, {E, CT::Maj7}, {F, CT::Maj7},
  {G, CT::Maj7}, {A, CT::Maj7}, {Bb, CT::Maj7}, {B, CT::Maj7},
  // Row 7: Half-diminished 7th (4) + Diminished 7th (4)
  {C, CT::HalfDim7}, {D, CT::HalfDim7}, {E, CT::HalfDim7}, {F, CT::HalfDim7},
  {C, CT::Dim7}, {Eb, CT::Dim7}, {Fs, CT::Dim7}, {A, CT::Dim7},
  ```
  </action>
  <verify>Build with `cmake --build build-release 2>&1 | tail -20`. Grep for `std::array<ScoredChord, 64>` in MorphEngine.h — should find return type. Grep for `std::array<Chord, 64>` in ChromaticPalette.h — should find return type. Grep for `kFinal = 64` in MorphEngine.cpp — should find the constant. Grep for `weightSum` in MorphEngine.cpp — should find normalization.</verify>
  <done>MorphEngine returns 64 scored chords with normalized [0,1] scores. ChromaticPalette provides 64 chords covering triads and 7th chords. Pool size cap widened to 72, variety minimum raised to 4.</done>
</task>

<task type="auto">
  <name>Task 2: Expand PersistentState to 64 with v1→v2 migration, update GridPanel and window size</name>
  <files>src/PersistentState.h, src/PersistentState.cpp, src/ui/GridPanel.h, src/ui/GridPanel.cpp, src/ui/PluginEditor.cpp</files>
  <action>
**PersistentState.h:**
- Change array sizes from 32 to 64:
  ```cpp
  std::array<Chord, 64> gridChords;
  std::array<std::string, 64> romanNumerals;
  ```

**PersistentState.cpp:**
- Change `kCurrentStateVersion = 1` → `kCurrentStateVersion = 2`.
- In `toValueTree()`: change the loop `for (int i = 0; i < 32; ++i)` → `for (int i = 0; i < 64; ++i)`.
- In `fromValueTree()`:
  - Change the range check `if (index < 0 || index >= 32) continue;` → `if (index < 0 || index >= 64) continue;`
  - After the grid loading loop, add v1→v2 migration: if the loaded version is 1 and fewer than 64 pads were loaded, fill indices 32–63 from `chromaticPalette()`:
    ```cpp
    if (version == 1)
    {
        auto palette = chromaticPalette();
        for (int i = 32; i < 64; ++i)
        {
            state.gridChords[static_cast<size_t>(i)] = palette[static_cast<size_t>(i)];
            state.romanNumerals[static_cast<size_t>(i)] = {};
        }
    }
    ```
    Place this after the `if (grid.isValid()) { ... }` block and before the morph context loading.

**GridPanel.h:** (if not already done by plan 08-01)
- No header changes needed for size — the loop counts are in the .cpp.

**GridPanel.cpp:**
- In the constructor, change `for (int i = 0; i < 32; ++i)` → `for (int i = 0; i < 64; ++i)`.
- In `morphTo()` (added by plan 08-01), change all `for (int i = 0; i < 32; ++i)` loops → `for (int i = 0; i < 64; ++i)`. There are two loops: one updating pads, one persisting state.
- In `refreshFromState()`, change all three `for (int i = 0; i < 32; ++i)` loops → `for (int i = 0; i < 64; ++i)` (morphed branch has one loop, unmorphed branch has one loop).
- In `resized()`, change `for (int i = 0; i < 4; ++i)` (rows) → `for (int i = 0; i < 8; ++i)` to create 8 rows.

**PluginEditor.cpp:**
- Change `setSize(1000, 650)` → `setSize(1000, 1200)` to accommodate 8 rows while maintaining current individual pad size.
  </action>
  <verify>Build with `cmake --build build-release 2>&1 | tail -20`. Must compile clean. Grep for `std::array<Chord, 64>` in PersistentState.h — should find declaration. Grep for `kCurrentStateVersion = 2` in PersistentState.cpp — should find version bump. Grep for `setSize(1000, 1200)` in PluginEditor.cpp. Grep for `i < 64` in GridPanel.cpp — should find multiple loops. Grep for `i < 8` in GridPanel.cpp resized — should find the row loop.</verify>
  <done>PersistentState stores 64 chords with v2 format and v1 backward migration. GridPanel creates, displays, and persists 64 pads in 8×8 layout. Plugin window is 1200px tall.</done>
</task>

</tasks>

<verification>
1. `cmake --build build-release` compiles without errors
2. `rg "std::array<ScoredChord, 64>" src/engine/MorphEngine.h` finds return type
3. `rg "std::array<Chord, 64>" src/midi/ChromaticPalette.h src/PersistentState.h` finds both
4. `rg "kCurrentStateVersion = 2" src/PersistentState.cpp` finds version bump
5. `rg "setSize.*1200" src/ui/PluginEditor.cpp` finds window size
6. `rg "i < 64" src/ui/GridPanel.cpp` finds expanded loops
7. `rg "version == 1" src/PersistentState.cpp` finds migration guard
</verification>

<success_criteria>
- MorphEngine returns std::array<ScoredChord, 64> with scores normalized to [0, 1]
- ChromaticPalette returns 64 chords (triads + 7th chords)
- PersistentState arrays are 64-element, version bumped to 2, v1 migration fills indices 32–63
- GridPanel creates 64 pads, arranges in 8×8, iterates to 64 in all loops
- Plugin window is 1000×1200
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-grid-ux-overhaul/08-02-SUMMARY.md`
</output>
