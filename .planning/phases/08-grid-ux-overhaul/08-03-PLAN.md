---
phase: 08-grid-ux-overhaul
plan: 03
type: execute
wave: 3
depends_on: [08-01, 08-02]
files_modified:
  - src/ui/ChordPumperLookAndFeel.h
  - src/ui/PadComponent.h
  - src/ui/PadComponent.cpp
  - src/ui/GridPanel.cpp
autonomous: true
requirements: []

must_haves:
  truths:
    - "After morph, pad border colours reflect harmonic similarity: blue (close) through red (distant)"
    - "Before any morph, pads use chord-type accent colours (existing behaviour preserved)"
    - "Colour gradient has 5 stops: red → purple → orange → green → blue across [0, 1] score range"
    - "Restored sessions display chord-type accent colours until user triggers a new morph"
  artifacts:
    - path: "src/ui/ChordPumperLookAndFeel.h"
      provides: "similarityColour function in PadColours namespace"
      contains: "similarityColour"
    - path: "src/ui/PadComponent.h"
      provides: "score_ member and setScore method"
      contains: "setScore"
    - path: "src/ui/PadComponent.cpp"
      provides: "paint uses similarity colour when score >= 0"
      contains: "similarityColour"
  key_links:
    - from: "src/ui/GridPanel.cpp"
      to: "src/ui/PadComponent.h"
      via: "morphTo passes scores to pads via setScore"
      pattern: "setScore"
    - from: "src/ui/PadComponent.cpp"
      to: "src/ui/ChordPumperLookAndFeel.h"
      via: "paint calls PadColours::similarityColour when morphed"
      pattern: "PadColours::similarityColour"
---

<objective>
Add harmonic similarity colour coding to grid pads. After morphing, pad borders use a 5-stop colour gradient (red→purple→orange→green→blue) based on the morph score, replacing the static chord-type accent.

Purpose: Visual feedback shows harmonic distance at a glance — users can see which chords are close (blue/green) vs adventurous (orange/purple/red) relative to the morph reference.
Output: Coloured grid pads after morph, chord-type accents when unmorphed.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-grid-ux-overhaul/08-RESEARCH.md
@.planning/phases/08-grid-ux-overhaul/08-01-SUMMARY.md
@.planning/phases/08-grid-ux-overhaul/08-02-SUMMARY.md
@src/ui/ChordPumperLookAndFeel.h
@src/ui/PadComponent.h
@src/ui/PadComponent.cpp
@src/ui/GridPanel.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add similarityColour function and PadComponent score rendering</name>
  <files>src/ui/ChordPumperLookAndFeel.h, src/ui/PadComponent.h, src/ui/PadComponent.cpp</files>
  <action>
**ChordPumperLookAndFeel.h — PadColours namespace:**
- Add the `similarityColour` function inside the `PadColours` namespace, after the existing `accentForType` function:
  ```cpp
  inline juce::Colour similarityColour(float score)
  {
      struct Stop { float pos; juce::Colour colour; };
      static const Stop stops[] = {
          { 0.00f, juce::Colour(0xffF44336) },  // red — extremely dissimilar
          { 0.25f, juce::Colour(0xff9C27B0) },  // purple — exotic
          { 0.45f, juce::Colour(0xffFF9800) },  // orange — bold
          { 0.65f, juce::Colour(0xff4CAF50) },  // green — good
          { 0.85f, juce::Colour(0xff4A9EFF) },  // blue — very similar
          { 1.00f, juce::Colour(0xff4A9EFF) },  // blue (clamp)
      };

      score = juce::jlimit(0.0f, 1.0f, score);
      for (int i = 0; i < 5; ++i)
      {
          if (score <= stops[i + 1].pos)
          {
              float t = (score - stops[i].pos) / (stops[i + 1].pos - stops[i].pos);
              return stops[i].colour.interpolatedWith(stops[i + 1].colour, t);
          }
      }
      return stops[5].colour;
  }
  ```

**PadComponent.h:**
- Add a new public method:
  ```cpp
  void setScore(float s);
  ```
- Add a new private member:
  ```cpp
  float score_ = -1.0f;
  ```
  Negative value is the sentinel meaning "no score / unmorphed".

**PadComponent.cpp:**
- Add the `setScore` method:
  ```cpp
  void PadComponent::setScore(float s)
  {
      score_ = s;
      repaint();
  }
  ```
- In `paint()`, change the accent border colour logic. Replace:
  ```cpp
  float accentAlpha = isPressed ? 0.8f : isHovered ? 0.6f : 0.4f;
  g.setColour(juce::Colour(PadColours::accentForType(chord.type)).withAlpha(accentAlpha));
  g.drawRoundedRectangle(bounds, cornerSize, 1.5f);
  ```
  With:
  ```cpp
  float accentAlpha = isPressed ? 0.8f : isHovered ? 0.6f : 0.4f;
  auto accentColour = (score_ >= 0.0f)
      ? PadColours::similarityColour(score_)
      : juce::Colour(PadColours::accentForType(chord.type));
  g.setColour(accentColour.withAlpha(accentAlpha));
  g.drawRoundedRectangle(bounds, cornerSize, 1.5f);
  ```
  When `score_ >= 0` (morphed state), use the similarity gradient colour. When `score_ < 0` (unmorphed / chromatic palette), fall back to the chord-type accent — preserving the familiar look.
  </action>
  <verify>Build with `cmake --build build-release 2>&1 | tail -20`. Grep for `similarityColour` in ChordPumperLookAndFeel.h — should find function. Grep for `score_` in PadComponent.h — should find member. Grep for `similarityColour` in PadComponent.cpp — should find paint usage.</verify>
  <done>similarityColour maps [0,1] to a 5-stop red→blue gradient. PadComponent uses similarity colour when score >= 0 and falls back to chord-type accent when unmorphed.</done>
</task>

<task type="auto">
  <name>Task 2: Wire scores through morphTo and refreshFromState</name>
  <files>src/ui/GridPanel.cpp</files>
  <action>
**GridPanel.cpp — morphTo():**
- Inside the loop that updates pads with morph suggestions, add a `setScore` call. The loop should become:
  ```cpp
  for (int i = 0; i < 64; ++i)
  {
      pads[i]->setChord(suggestions[static_cast<size_t>(i)].chord);
      pads[i]->setRomanNumeral(suggestions[static_cast<size_t>(i)].romanNumeral);
      pads[i]->setScore(suggestions[static_cast<size_t>(i)].score);
  }
  ```
  This passes the normalized [0,1] score from MorphEngine through to PadComponent for colour rendering.

**GridPanel.cpp — refreshFromState():**
- In the `if (persistentState.hasMorphed)` branch, after setting chord and roman numeral, add score reset to a neutral value. Since the persisted state doesn't store individual scores (they're derived from morph), set a default. Two options:
  - Re-morph to get scores (expensive, requires morph call)
  - Set score to -1 to use chord-type accent colours (simple, fast)
  
  Use option 2 for simplicity — the user will re-morph when they interact with the strip:
  ```cpp
  for (int i = 0; i < 64; ++i)
  {
      pads[i]->setChord(persistentState.gridChords[static_cast<size_t>(i)]);
      pads[i]->setRomanNumeral(persistentState.romanNumerals[static_cast<size_t>(i)]);
      pads[i]->setScore(-1.0f);
  }
  ```

- In the `else` (unmorphed / chromatic palette) branch, ensure scores are reset:
  ```cpp
  for (int i = 0; i < 64; ++i)
  {
      pads[i]->setChord(palette[static_cast<size_t>(i)]);
      pads[i]->setRomanNumeral({});
      pads[i]->setScore(-1.0f);
  }
  ```
  This ensures chromatic palette pads always use chord-type accent colours.
  </action>
  <verify>Build with `cmake --build build-release 2>&1 | tail -20`. Grep for `setScore` in GridPanel.cpp — should find calls in morphTo (with suggestion score) and refreshFromState (with -1.0f).</verify>
  <done>morphTo passes morph scores to pads. refreshFromState resets scores to -1 so restored/unmorphed pads use chord-type accents. Similarity colours are visible after any morph trigger.</done>
</task>

</tasks>

<verification>
1. `cmake --build build-release` compiles without errors
2. `rg "similarityColour" src/ui/ChordPumperLookAndFeel.h src/ui/PadComponent.cpp` finds function and usage
3. `rg "setScore" src/ui/PadComponent.h src/ui/GridPanel.cpp` finds declaration and all call sites
4. `rg "score_ >= 0" src/ui/PadComponent.cpp` finds the conditional in paint
5. `rg "score_.*-1" src/ui/GridPanel.cpp` finds reset calls in refreshFromState
</verification>

<success_criteria>
- PadColours::similarityColour maps [0,1] score to 5-stop gradient (red→purple→orange→green→blue)
- PadComponent has score_ member, setScore method, and paint uses similarity colour when score >= 0
- GridPanel.morphTo passes scores to pads via setScore
- GridPanel.refreshFromState resets scores to -1.0f (unmorphed state uses chord-type accents)
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-grid-ux-overhaul/08-03-SUMMARY.md`
</output>
