---
phase: 08-grid-ux-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/PadComponent.h
  - src/ui/PadComponent.cpp
  - src/ui/GridPanel.h
  - src/ui/GridPanel.cpp
  - src/ui/ProgressionStrip.h
  - src/ui/ProgressionStrip.cpp
  - src/ui/PluginEditor.cpp
autonomous: true
requirements: []

must_haves:
  truths:
    - "Holding a grid pad sustains MIDI note-on; releasing fires note-off immediately"
    - "Grid does NOT morph when a pad is clicked — only preview plays"
    - "Dragging a pad into the progression strip triggers grid morph to that chord"
    - "Clicking a chord in the progression strip morphs the grid AND plays the chord"
    - "Notes release immediately when a drag begins (no stuck notes)"
  artifacts:
    - path: "src/ui/PadComponent.h"
      provides: "onPressStart and onPressEnd callbacks"
      contains: "onPressStart"
    - path: "src/ui/GridPanel.h"
      provides: "Public morphTo method, no Timer inheritance"
      contains: "morphTo"
    - path: "src/ui/ProgressionStrip.h"
      provides: "onChordDropped callback"
      contains: "onChordDropped"
  key_links:
    - from: "src/ui/PadComponent.cpp"
      to: "src/ui/GridPanel.cpp"
      via: "onPressStart callback fires startPreview"
      pattern: "onPressStart"
    - from: "src/ui/ProgressionStrip.cpp"
      to: "src/ui/PluginEditor.cpp"
      via: "onChordDropped callback wired to gridPanel.morphTo"
      pattern: "onChordDropped"
    - from: "src/ui/PluginEditor.cpp"
      to: "src/ui/GridPanel.cpp"
      via: "strip.onChordClicked calls gridPanel.morphTo"
      pattern: "gridPanel\\.morphTo"
---

<objective>
Replace click-to-play-and-morph with hold-to-preview (sustained MIDI) and strip-driven morphing. Pad clicks only preview; morphing triggers exclusively from strip interactions.

Purpose: Decouple preview from morph — users explore freely by holding pads, and intentionally morph by dragging to strip or clicking strip chords.
Output: New interaction model where pads preview on hold, strip drives all morphing.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-grid-ux-overhaul/08-RESEARCH.md
@src/ui/PadComponent.h
@src/ui/PadComponent.cpp
@src/ui/GridPanel.h
@src/ui/GridPanel.cpp
@src/ui/ProgressionStrip.h
@src/ui/ProgressionStrip.cpp
@src/ui/PluginEditor.h
@src/ui/PluginEditor.cpp
@src/engine/VoiceLeader.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor PadComponent for hold-to-preview and add GridPanel morphTo</name>
  <files>src/ui/PadComponent.h, src/ui/PadComponent.cpp, src/ui/GridPanel.h, src/ui/GridPanel.cpp</files>
  <action>
**PadComponent.h:**
- Add two new public callback members alongside existing `onClick`:
  ```cpp
  std::function<void(const Chord&)> onPressStart;
  std::function<void(const Chord&)> onPressEnd;
  ```
- Keep `onClick` — it is no longer wired to morph, but the PadComponent still fires it on clean click (mouseUp without drag). It will simply not be connected to anything morph-related by the Editor.

**PadComponent.cpp — mouseDown:**
- After existing `isPressed = true; isDragInProgress = false; repaint();` block, add:
  ```cpp
  if (onPressStart)
      onPressStart(chord);
  ```
  This fires noteOn immediately on press.

**PadComponent.cpp — mouseDrag:**
- After `isDragInProgress = true;` and BEFORE `startDragging(...)`, insert:
  ```cpp
  if (onPressEnd)
      onPressEnd(chord);
  ```
  This releases notes before drag begins — prevents stuck notes.

**PadComponent.cpp — mouseUp:**
- Replace the body after `isPressed = false; repaint();`. New logic:
  ```cpp
  if (!isDragInProgress)
  {
      if (onPressEnd)
          onPressEnd(chord);
      if (event.getDistanceFromDragStart() < 6 && onClick)
          onClick(chord);
  }
  isDragInProgress = false;
  ```
  Note: `onPressEnd` fires on mouseUp (releases notes), then `onClick` fires for clean clicks. The `onClick` callback is kept but no longer triggers morph — it exists for any future use (currently nothing wires it).

**GridPanel.h:**
- Remove `, private juce::Timer` from class declaration (no longer inherits Timer)
- Remove `void timerCallback() override;` from private section
- Remove `static constexpr int noteDurationMs = 300;` 
- Remove `std::function<void(const Chord&)> onChordPlayed;` from public section
- Remove `void padClicked(const Chord& chord);` from private section
- Add to public section:
  ```cpp
  void morphTo(const Chord& chord);
  ```
- Add to private section:
  ```cpp
  void startPreview(const Chord& chord);
  void stopPreview();
  ```

**GridPanel.cpp:**
- In constructor: replace `pad->onClick = [this](const Chord& chord) { padClicked(chord); };` with:
  ```cpp
  pad->onPressStart = [this](const Chord& c) { startPreview(c); };
  pad->onPressEnd   = [this](const Chord&)   { stopPreview(); };
  ```
- Delete the entire `padClicked` method.
- Delete the `timerCallback` method.
- Add `startPreview` method:
  ```cpp
  void GridPanel::startPreview(const Chord& chord)
  {
      releaseCurrentChord();
      auto voiced = optimalVoicing(chord, activeNotes, defaultOctave);
      for (auto note : voiced.midiNotes)
          keyboardState.noteOn(midiChannel, note, velocity);
      activeNotes.assign(voiced.midiNotes.begin(), voiced.midiNotes.end());
  }
  ```
  NO timer, NO morph, NO state persistence — purely preview.
- Add `stopPreview` method:
  ```cpp
  void GridPanel::stopPreview()
  {
      releaseCurrentChord();
  }
  ```
- Add `morphTo` public method:
  ```cpp
  void GridPanel::morphTo(const Chord& chord)
  {
      auto voiced = optimalVoicing(chord, activeNotes, defaultOctave);
      auto suggestions = morphEngine.morph(chord, voiced.midiNotes);

      for (int i = 0; i < 32; ++i)
      {
          pads[i]->setChord(suggestions[static_cast<size_t>(i)].chord);
          pads[i]->setRomanNumeral(suggestions[static_cast<size_t>(i)].romanNumeral);
      }

      {
          const juce::ScopedLock sl(stateLock);
          persistentState.lastPlayedChord = chord;
          persistentState.lastVoicing.assign(voiced.midiNotes.begin(), voiced.midiNotes.end());
          persistentState.hasMorphed = true;
          for (int i = 0; i < 32; ++i)
          {
              persistentState.gridChords[static_cast<size_t>(i)] = suggestions[static_cast<size_t>(i)].chord;
              persistentState.romanNumerals[static_cast<size_t>(i)] = suggestions[static_cast<size_t>(i)].romanNumeral;
          }
      }
      repaint();
  }
  ```
  Note: Uses 32 for now — plan 08-02 will expand to 64. The morphTo method moves the morph+persist logic from the deleted padClicked into a public method callable by the Editor.
  </action>
  <verify>Build with `cmake --build build-release 2>&1 | tail -20`. Must compile with no errors. Grep for `timerCallback` and `padClicked` in GridPanel — should return nothing. Grep for `onChordPlayed` in GridPanel — should return nothing. Grep for `morphTo` in GridPanel.h — should find the declaration.</verify>
  <done>GridPanel no longer inherits Timer. Pads fire onPressStart/onPressEnd for preview. morphTo() is a public method. padClicked and timerCallback are deleted. No morph logic fires on pad interaction.</done>
</task>

<task type="auto">
  <name>Task 2: Wire strip-driven morph triggers in Editor and ProgressionStrip</name>
  <files>src/ui/ProgressionStrip.h, src/ui/ProgressionStrip.cpp, src/ui/PluginEditor.cpp</files>
  <action>
**ProgressionStrip.h:**
- Add a new public callback member next to `onChordClicked`:
  ```cpp
  std::function<void(const Chord&)> onChordDropped;
  ```

**ProgressionStrip.cpp — itemDropped:**
- Replace the current body with:
  ```cpp
  void ProgressionStrip::itemDropped(const SourceDetails& details)
  {
      if (auto* pad = dynamic_cast<PadComponent*>(details.sourceComponent.get()))
      {
          const auto& chord = pad->getChord();
          addChord(chord);
          if (onChordDropped)
              onChordDropped(chord);
      }
      isReceivingDrag = false;
      repaint();
  }
  ```
  The `onChordDropped` callback fires AFTER `addChord` so the strip is updated before morph begins.

**PluginEditor.cpp — constructor:**
- Replace the existing `progressionStrip.onChordClicked` lambda with one that morphs the grid AND plays the chord:
  ```cpp
  progressionStrip.onChordClicked = [this](const Chord& c) {
      gridPanel.morphTo(c);
      auto& ks = processor.getKeyboardState();
      auto notes = c.midiNotes(4);
      for (auto n : notes) ks.noteOn(1, n, 0.8f);
      juce::Timer::callAfterDelay(300,
          [safeThis = juce::Component::SafePointer<ChordPumperEditor>(this), notes]() {
              if (safeThis == nullptr) return;
              auto& ks2 = safeThis->processor.getKeyboardState();
              for (auto n : notes) ks2.noteOff(1, n, 0.0f);
          });
  };
  ```
  NOTE: morphTo is called FIRST so the grid updates, then the chord plays with a 300ms timer (strip click uses timer since there's no mouseUp to trigger release — unlike pad hold-to-preview).

- Add the new `onChordDropped` wiring after the `onChordClicked` wiring:
  ```cpp
  progressionStrip.onChordDropped = [this](const Chord& c) {
      gridPanel.morphTo(c);
  };
  ```

- Remove any wiring of `gridPanel.onChordPlayed` if it exists (it was removed from GridPanel.h in Task 1, so any reference here would cause a compile error — just ensure it's not referenced).
  </action>
  <verify>Build with `cmake --build build-release 2>&1 | tail -20`. Must compile clean. Grep for `onChordDropped` in ProgressionStrip.h — should find declaration. Grep for `gridPanel.morphTo` in PluginEditor.cpp — should find two calls (one in onChordClicked, one in onChordDropped). Grep for `onChordPlayed` in PluginEditor.cpp — should return nothing.</verify>
  <done>Strip click morphs grid then plays chord. Strip drop morphs grid. No morph triggers from pad clicks. All wiring flows through Editor lambdas.</done>
</task>

</tasks>

<verification>
1. `cmake --build build-release` compiles without errors
2. `rg "timerCallback|padClicked|onChordPlayed" src/ui/GridPanel.h src/ui/GridPanel.cpp` returns no matches
3. `rg "morphTo" src/ui/GridPanel.h` finds public declaration
4. `rg "onPressStart|onPressEnd" src/ui/PadComponent.h` finds both callbacks
5. `rg "onChordDropped" src/ui/ProgressionStrip.h` finds callback
6. `rg "gridPanel.morphTo" src/ui/PluginEditor.cpp` finds two calls
</verification>

<success_criteria>
- Pads have onPressStart (fires noteOn on mouseDown) and onPressEnd (fires noteOff on mouseUp or drag start)
- GridPanel has no Timer inheritance, no timerCallback, no padClicked, no onChordPlayed
- GridPanel has public morphTo() method that computes morph + persists state
- ProgressionStrip fires onChordDropped in itemDropped
- Editor wires strip.onChordClicked to morphTo + play, strip.onChordDropped to morphTo
- Build succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-grid-ux-overhaul/08-01-SUMMARY.md`
</output>
