---
phase: 07-ux-polish-progression-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/PadComponent.h
  - src/ui/PadComponent.cpp
  - src/ui/ProgressionStrip.h
  - src/ui/ProgressionStrip.cpp
  - src/ui/PluginEditor.h
  - src/ui/PluginEditor.cpp
autonomous: true
requirements: [UX-01, UX-02]

must_haves:
  truths:
    - "Clicking a grid pad plays the chord sound but does NOT add it to the progression strip"
    - "Dragging a grid pad onto the progression strip adds that chord to the sequence"
    - "Dragging a pad outside the plugin window still creates a MIDI file for external DnD"
    - "The strip shows a visual highlight when a pad is being dragged over it"
  artifacts:
    - path: "src/ui/PadComponent.cpp"
      provides: "mouseUp-based onClick and startDragging-based intra-plugin DnD"
      contains: "startDragging"
    - path: "src/ui/ProgressionStrip.h"
      provides: "DragAndDropTarget interface on ProgressionStrip"
      contains: "DragAndDropTarget"
    - path: "src/ui/ProgressionStrip.cpp"
      provides: "itemDropped handler that adds chord from PadComponent source"
      contains: "itemDropped"
    - path: "src/ui/PluginEditor.cpp"
      provides: "No auto-add wiring; shouldDropFilesWhenDraggedExternally override"
      contains: "shouldDropFilesWhenDraggedExternally"
  key_links:
    - from: "src/ui/PadComponent.cpp"
      to: "DragAndDropContainer"
      via: "findParentDragContainerFor(this)->startDragging()"
      pattern: "startDragging"
    - from: "src/ui/ProgressionStrip.cpp"
      to: "PadComponent"
      via: "dynamic_cast in itemDropped to get chord from source"
      pattern: "dynamic_cast<PadComponent"
    - from: "src/ui/PadComponent.cpp"
      to: "onClick callback"
      via: "mouseUp fires onClick when distance < 6px and no drag in progress"
      pattern: "mouseUp.*onClick"
---

<objective>
Rewire PadComponent and ProgressionStrip so that clicking a grid pad only plays/morphs (no strip add), while dragging a pad into the strip adds the chord. This is the core UX behavioral change of Phase 7.

Purpose: Transforms the progression strip from a passive history log into an intentional composition tool — users choose which chords to keep.
Output: Working intra-plugin drag-and-drop from grid pads to strip, with click-only-plays behavior.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-ux-polish-progression-workflow/07-RESEARCH.md

@src/ui/PadComponent.h
@src/ui/PadComponent.cpp
@src/ui/ProgressionStrip.h
@src/ui/ProgressionStrip.cpp
@src/ui/PluginEditor.h
@src/ui/PluginEditor.cpp
@src/ui/GridPanel.h
@src/ui/GridPanel.cpp
@src/midi/MidiFileBuilder.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rework PadComponent click/drag disambiguation</name>
  <files>src/ui/PadComponent.h, src/ui/PadComponent.cpp</files>
  <action>
  Change PadComponent's mouse handling so clicking and dragging are fully disambiguated:

  **mouseDown** — Remove the `onClick(chord)` call. Keep: right-click export fallback (unchanged), `isPressed = true`, `isDragInProgress = false`, `repaint()`. Do NOT call onClick here anymore.

  **mouseUp** — After setting `isPressed = false` and `repaint()`, add click detection: if `!isDragInProgress && event.getDistanceFromDragStart() < 6`, call `onClick(chord)`. Then reset `isDragInProgress = false`.

  **mouseDrag** — Replace `performExternalDragDropOfFiles` with JUCE intra-plugin DnD:
  - Keep the `event.getDistanceFromDragStart() < 6` early return
  - Keep the `isDragInProgress` guard
  - Set `isDragInProgress = true`
  - Find the parent DragAndDropContainer via `juce::DragAndDropContainer::findParentDragContainerFor(this)`
  - Call `container->startDragging(juce::var(juce::String(chord.name())), this, juce::ScaledImage{}, false)`
  - Remove the `MidiFileBuilder::createMidiFile` call and the entire external DnD block — external DnD will be handled by the editor's `shouldDropFilesWhenDraggedExternally` override instead

  The `#include "midi/MidiFileBuilder.h"` in PadComponent.cpp can be removed since MidiFileBuilder is no longer called directly from PadComponent.
  </action>
  <verify>Build succeeds (`cmake --build build-release`). Clicking a pad still plays the chord and morphs the grid (via GridPanel::padClicked). Dragging past 6px no longer creates temp MIDI files.</verify>
  <done>mouseDown does not call onClick. mouseUp calls onClick only when distance < 6px and no drag occurred. mouseDrag calls startDragging instead of performExternalDragDropOfFiles.</done>
</task>

<task type="auto">
  <name>Task 2: Make ProgressionStrip a DragAndDropTarget and disconnect auto-add</name>
  <files>src/ui/ProgressionStrip.h, src/ui/ProgressionStrip.cpp, src/ui/PluginEditor.h, src/ui/PluginEditor.cpp</files>
  <action>
  **ProgressionStrip.h** — Add `juce::DragAndDropTarget` to ProgressionStrip's inheritance list. Add these public method declarations:
  - `bool isInterestedInDragSource(const SourceDetails& details) override;`
  - `void itemDropped(const SourceDetails& details) override;`
  - `void itemDragEnter(const SourceDetails& details) override;`
  - `void itemDragExit(const SourceDetails& details) override;`
  Add a private `bool isReceivingDrag = false;` member.

  **ProgressionStrip.cpp** — Add `#include "PadComponent.h"` at the top (needed for dynamic_cast).

  Implement the DragAndDropTarget methods:
  - `isInterestedInDragSource`: return `dynamic_cast<PadComponent*>(details.sourceComponent.get()) != nullptr`
  - `itemDropped`: `auto* pad = dynamic_cast<PadComponent*>(details.sourceComponent.get()); if (pad) addChord(pad->getChord()); isReceivingDrag = false; repaint();`
  - `itemDragEnter`: set `isReceivingDrag = true; repaint();`
  - `itemDragExit`: set `isReceivingDrag = false; repaint();`

  In `paint()`, add a drop highlight at the end of the method: when `isReceivingDrag` is true, draw a semi-transparent overlay — `g.setColour(juce::Colour(0xff6c8ebf).withAlpha(0.15f)); g.fillRoundedRectangle(getLocalBounds().toFloat(), 4.0f);` and a border `g.setColour(juce::Colour(0xff6c8ebf).withAlpha(0.5f)); g.drawRoundedRectangle(getLocalBounds().toFloat().reduced(1.0f), 4.0f, 2.0f);`

  **PluginEditor.cpp** — Remove the line `gridPanel.onChordPlayed = [this](const Chord& c) { progressionStrip.addChord(c); };` from the constructor. GridPanel still plays MIDI and morphs on click — it just no longer auto-adds to the strip.

  **PluginEditor.h** — Add override declaration: `bool shouldDropFilesWhenDraggedExternally(const juce::DragAndDropTarget::SourceDetails& details, juce::StringArray& files, bool& canMoveFiles) override;`

  **PluginEditor.cpp** — Implement `shouldDropFilesWhenDraggedExternally`: dynamic_cast sourceComponent to PadComponent*, if valid call `MidiFileBuilder::createMidiFile(pad->getChord(), 4)`, add the file path to `files`, set `canMoveFiles = false`, return true. Add `#include "midi/MidiFileBuilder.h"` and `#include "PadComponent.h"` at top of PluginEditor.cpp if not already present.
  </action>
  <verify>Build succeeds. Drag a pad past 6px — strip highlights. Release on strip — chord appears in strip. Click a pad — chord plays and morphs but strip is unchanged. Drag a pad outside the plugin window — external DnD attempts with MIDI file.</verify>
  <done>ProgressionStrip implements DragAndDropTarget and receives chord drops from PadComponent. Clicking pads no longer adds to strip. External DnD fallback works via shouldDropFilesWhenDraggedExternally.</done>
</task>

</tasks>

<verification>
1. Build: `cmake --build build-release` completes without errors or warnings
2. Click test: Click a grid pad → chord plays via MIDI, grid morphs, strip is NOT affected
3. Drag test: Drag a pad into the strip → strip highlight appears during drag, chord added on drop
4. External DnD test: Drag a pad outside the plugin window → MIDI file created for external drop
5. Right-click test: Right-click a pad → chord exported to ~/ChordPumper-Export/ (unchanged behavior)
6. State test: Chords added via drag persist across strip clear/re-add cycles
</verification>

<success_criteria>
- PadComponent click (< 6px mouse movement) plays chord and morphs grid without adding to strip
- PadComponent drag (>= 6px) initiates intra-plugin DnD via startDragging
- ProgressionStrip accepts drops from PadComponent and adds chord to sequence
- Strip shows visual feedback during drag-over
- External DnD fallback creates MIDI file via shouldDropFilesWhenDraggedExternally
- All existing functionality (morph, state persistence, right-click export) preserved
</success_criteria>

<output>
After completion, create `.planning/phases/07-ux-polish-progression-workflow/07-01-SUMMARY.md`
</output>
