---
phase: 06-state-persistence-validation
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - src/PluginProcessor.cpp
autonomous: false
requirements: [PLAT-06, PLAT-07]

must_haves:
  truths:
    - "Plugin passes pluginval at strictness level 5 with zero test failures for VST3 format"
    - "Plugin passes pluginval at strictness level 5 with zero test failures for CLAP format"
    - "processBlock contains no allocations or blocking calls"
    - "State save/restore verified in Bitwig: close session → reopen → grid and progression match"
  artifacts:
    - path: "src/PluginProcessor.cpp"
      provides: "Real-time safe processBlock (no allocations, no locks)"
      contains: "processBlock"
  key_links:
    - from: "pluginval"
      to: "src/PluginProcessor.cpp"
      via: "pluginval invokes getStateInformation/setStateInformation and verifies round-trip"
      pattern: "getStateInformation"
    - from: "pluginval"
      to: "src/PluginProcessor.cpp"
      via: "pluginval calls processBlock at various sample rates and block sizes"
      pattern: "processBlock"
---

<objective>
Validate the plugin with pluginval at strictness level 5 for VST3 and CLAP, audit processBlock for real-time safety, and verify state persistence in Bitwig.

Purpose: Satisfies PLAT-07 (pluginval validation) and provides final verification of PLAT-06 (state persistence in a real DAW). This is the production quality gate — no shipping without pluginval passing.
Output: Validated plugin artifacts, confirmed real-time safety, verified state persistence in Bitwig.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-state-persistence-validation/06-RESEARCH.md
@.planning/phases/06-state-persistence-validation/06-01-SUMMARY.md
@.planning/phases/06-state-persistence-validation/06-02-SUMMARY.md

@src/PluginProcessor.h
@src/PluginProcessor.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: pluginval validation at level 5 and processBlock audit</name>
  <files>src/PluginProcessor.cpp</files>
  <action>
**Build Release:**

Build the plugin in Release mode for accurate validation:
```bash
cmake -B build-release -DCMAKE_BUILD_TYPE=Release -DCHORDPUMPER_BUILD_TESTS=OFF -G Ninja
cmake --build build-release
```

**Download pluginval:**

Download pluginval v1.0.4 Linux binary:
```bash
wget -q https://github.com/Tracktion/pluginval/releases/download/v1.0.4/pluginval_Linux.zip -O /tmp/pluginval_Linux.zip
unzip -o /tmp/pluginval_Linux.zip -d /tmp/pluginval
chmod +x /tmp/pluginval/pluginval
```

If the exact URL fails, check the latest release at `https://github.com/Tracktion/pluginval/releases` and adjust.

**Run pluginval on VST3 at level 5:**
```bash
/tmp/pluginval/pluginval --strictness-level 5 --validate-in-process --verbose \
  "build-release/ChordPumper_artefacts/VST3/ChordPumper.vst3"
```

Note: Use `--validate-in-process` for better error messages if tests fail. If pluginval reports failures, fix them. Common fixes needed:
- State test failures: debug getStateInformation/setStateInformation (should work after Plan 01)
- Editor creation failures: verify createEditor returns non-null with valid size
- Audio processing failures: verify processBlock handles all sample rates and block sizes
- Bus layout failures: verify BusesProperties configuration

**Run pluginval on CLAP at level 5:**
```bash
/tmp/pluginval/pluginval --strictness-level 5 --validate-in-process --verbose \
  "$HOME/.clap/ChordPumper.clap"
```

If pluginval doesn't support CLAP loading on this system, skip and note in summary.

**processBlock audit:**

Review `processBlock` and all functions it calls for real-time safety:
- `buffer.clear()` — safe (no allocation)
- `midiMessages.clear()` — safe (no allocation, just resets internal position)
- `keyboardState.processNextMidiBuffer(midiMessages, ...)` — verify this does not allocate. Read the JUCE source for `MidiKeyboardState::processNextMidiBuffer` to confirm. If it uses `MidiBuffer::addEvent` that could grow the buffer, pre-allocate in `prepareToPlay` using `midiMessages.ensureSize(2048)` or similar.

If any allocation is found in the processBlock call chain, fix it (e.g., pre-allocate buffers in `prepareToPlay`).

Optionally run pluginval at level 7 as a stretch goal to test background thread state safety. Do NOT attempt level 9 (allocation interception) unless levels 5-7 pass cleanly — level 9 failures on Linux can be spurious due to system library allocations.

**Fix any failures** by modifying the relevant source files. If failures are in processBlock, fix in PluginProcessor.cpp. If in editor, fix in the appropriate UI file.
  </action>
  <verify>
pluginval output shows "ALL instruments PASSED" (or equivalent success message) at strictness level 5 for VST3. If CLAP validation ran, it also passes. No "FAILED" lines in output.
  </verify>
  <done>Plugin passes pluginval at strictness level 5 for VST3 (and CLAP if supported). processBlock confirmed real-time safe with no allocations or locks.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify state persistence in Bitwig</name>
  <what-built>Complete state persistence implementation: PersistentState serialization (Plan 01), Editor↔Processor state wiring (Plan 02), and pluginval validation (Task 1 above). The plugin should now save and restore its full state across DAW session reloads.</what-built>
  <how-to-verify>
1. Open Bitwig Studio and create a new project
2. Add ChordPumper (VST3 or CLAP) to an instrument track
3. Open the plugin window — should show chromatic palette
4. Click several pads to trigger morphing — grid should morph with Roman numerals
5. Note which chords are on the grid and in the progression strip
6. Save the Bitwig project (Ctrl+S)
7. Close Bitwig completely
8. Reopen Bitwig and load the saved project
9. Open ChordPumper plugin window
10. **Verify:** The grid shows the exact same morphed chords with Roman numerals (NOT the chromatic palette)
11. **Verify:** The progression strip shows the same chord sequence as before saving
12. **Verify:** Clicking a pad morphs from the restored state (voice leading continues from where you left off)

**Expected result:** Everything restored exactly. If the grid resets to chromatic palette, state persistence is broken.
  </how-to-verify>
  <resume-signal>Type "approved" if state persists correctly, or describe what was wrong (e.g., "grid reset to chromatic palette" or "progression strip was empty")</resume-signal>
</task>

</tasks>

<verification>
1. pluginval level 5 passes for VST3 format
2. pluginval level 5 passes for CLAP format (if pluginval supports it)
3. processBlock contains only: buffer.clear(), midiMessages.clear(), processNextMidiBuffer — no allocations
4. Bitwig session save → close → reopen restores grid state, morph state, and progression exactly
</verification>

<success_criteria>
- pluginval at strictness 5 reports zero failures for VST3
- CLAP validation passes (or documented as unsupported by pluginval on this platform)
- processBlock verified allocation-free
- State survives Bitwig session reload (human verified)
- No audio dropouts or glitches during normal chord exploration
</success_criteria>

<output>
After completion, create `.planning/phases/06-state-persistence-validation/06-03-SUMMARY.md`
</output>
