---
phase: 04-morphing-suggestions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/PitchClassSet.h
  - src/engine/ScaleDatabase.h
  - src/engine/VoiceLeader.h
  - src/engine/VoiceLeader.cpp
  - src/engine/RomanNumeral.h
  - src/engine/RomanNumeral.cpp
  - tests/test_pitch_class_set.cpp
  - tests/test_voice_leader.cpp
  - tests/test_roman_numeral.cpp
  - CMakeLists.txt
autonomous: true
requirements: [CHRD-03, GRID-04, GRID-06]

must_haves:
  truths:
    - "Common tones between any two chords can be counted via bitwise AND + popcount in O(1)"
    - "Voice leading distance finds the minimum total semitone movement across all voice assignments"
    - "Optimal voicing places target chord notes to minimize movement from previous voicing"
    - "Roman numerals correctly label the interval between any reference chord and suggestion chord"
    - "All 108 candidate chords (12 roots × 9 types) are available as a constexpr catalog"
  artifacts:
    - path: "src/engine/PitchClassSet.h"
      provides: "Bitset pitch-class representation, commonToneCount, allChords catalog"
      contains: "pitchClassSet"
    - path: "src/engine/ScaleDatabase.h"
      provides: "Constexpr mode patterns for all 7 diatonic modes"
      contains: "kModePatterns"
    - path: "src/engine/VoiceLeader.h"
      provides: "VoiceLeader class declaration"
      contains: "voiceLeadingDistance"
    - path: "src/engine/VoiceLeader.cpp"
      provides: "Brute-force permutation voice leading implementation"
      min_lines: 30
    - path: "src/engine/RomanNumeral.h"
      provides: "Roman numeral lookup table and generation function"
      contains: "kRomanNumerals"
    - path: "src/engine/RomanNumeral.cpp"
      provides: "romanNumeral() implementation"
    - path: "tests/test_voice_leader.cpp"
      provides: "Voice leading distance and optimal voicing tests"
      min_lines: 40
    - path: "tests/test_roman_numeral.cpp"
      provides: "Roman numeral generation tests for all 12 intervals"
      min_lines: 30
  key_links:
    - from: "src/engine/PitchClassSet.h"
      to: "src/engine/Chord.h"
      via: "pitchClassSet() reads Chord root + type + kIntervals"
      pattern: "pitchClassSet.*Chord"
    - from: "src/engine/VoiceLeader.cpp"
      to: "src/engine/Chord.h"
      via: "optimalVoicing takes Chord and returns VoicedChord"
      pattern: "optimalVoicing.*Chord"
    - from: "src/engine/RomanNumeral.cpp"
      to: "src/engine/PitchClass.h"
      via: "semitone interval between two chord roots"
      pattern: "semitone\\(\\)"
---

<objective>
Build the four foundation engine classes that Phase 4's morph algorithm depends on: pitch-class set operations, diatonic scale database, voice leading optimizer, and Roman numeral generator. All live in src/engine/ with zero JUCE dependency, fully tested with Catch2.

Purpose: These primitives are the building blocks for Plan 02's MorphEngine. Each is independently testable and provides a single well-defined capability.
Output: 6 new engine source files, 3 new test files, all tests passing.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-morphing-suggestions/04-RESEARCH.md

@src/engine/PitchClass.h
@src/engine/ChordType.h
@src/engine/Chord.h
@src/engine/Chord.cpp
@src/engine/NoteLetter.h
@CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement engine foundation classes</name>
  <files>
    src/engine/PitchClassSet.h
    src/engine/ScaleDatabase.h
    src/engine/VoiceLeader.h
    src/engine/VoiceLeader.cpp
    src/engine/RomanNumeral.h
    src/engine/RomanNumeral.cpp
  </files>
  <action>
    Create six new files in src/engine/ with zero JUCE dependency:

    **PitchClassSet.h** (header-only):
    - `using PitchClassSet = uint16_t;` — 12-bit bitmask where bit N = 1 if semitone N is in the chord
    - `constexpr PitchClassSet pitchClassSet(const Chord& chord)` — builds bitmask from chord root semitone + kIntervals. Loop over noteCount(chord.type) intervals, set bit at `(rootSemitone + interval) % 12`
    - `constexpr int commonToneCount(PitchClassSet a, PitchClassSet b)` — returns `__builtin_popcount(a & b)`
    - `constexpr std::array<Chord, 108> allChords()` function — iterates 12 roots (pitches::C through pitches::B) × 9 ChordTypes, returns fixed array. Store as `inline constexpr auto kAllChords = allChords();`
    - Use the 12 canonical PitchClass constants from pitches:: namespace for roots

    **ScaleDatabase.h** (header-only, constexpr):
    - `struct ScalePattern` with three `std::array` fields: `intervals[7]` (semitones from root), `triadQualities[7]`, `seventhQualities[7]`
    - `inline constexpr std::array<ScalePattern, 7> kModePatterns` — all 7 diatonic modes (Ionian, Dorian, Phrygian, Lydian, Mixolydian, Aeolian, Locrian) with correct interval patterns and chord qualities per degree. Use the exact data from the research Pattern 3 table.

    **VoiceLeader.h / VoiceLeader.cpp**:
    - `struct VoicedChord { Chord chord; std::vector<int> midiNotes; };`
    - `int voiceLeadingDistance(const std::vector<int>& from, const std::vector<int>& to)` — brute-force over all permutations of the smaller set. For equal-size chords: try all n! permutations (max 4! = 24), sum |from[i] - to[perm[i]]| for each, return minimum. For different-size chords (triad↔7th): use the common size for permutation, add minimum distance for the extra note (distance to nearest source note).
    - `VoicedChord optimalVoicing(const Chord& target, const std::vector<int>& previousNotes, int octave)` — generates candidate voicings of the target chord by placing each pitch class at the closest octave to the centroid of previousNotes (try the target note at octave and octave±1, pick closest). Then runs voiceLeadingDistance to find the permutation-optimal assignment. If previousNotes is empty (first click), returns root-position voicing at the given octave.
    - Use `<algorithm>` for std::next_permutation, `<numeric>` for std::iota, `<cmath>` for std::abs.
    - Do NOT use Dijkstra or any graph algorithm — brute-force is correct and fast for n≤4.

    **RomanNumeral.h / RomanNumeral.cpp**:
    - `struct RomanNumeralInfo { int interval; const char* upperCase; const char* lowerCase; };`
    - `inline constexpr std::array<RomanNumeralInfo, 12> kRomanNumerals` — lookup table mapping semitone intervals 0–11 to Roman numeral strings. Use Unicode ♭ (U+266D) and ♯ (U+266F) for accidentals. Interval 6 (tritone): use ♯IV/♯iv for major/aug qualities, ♭V/♭v for minor/dim qualities — handle in romanNumeral() function, not in the table.
    - `bool isUpperCase(ChordType type)` — returns true for Major, Augmented, Maj7, Dom7; false for Minor, Diminished, Dim7, HalfDim7.
    - `std::string romanNumeral(const Chord& reference, const Chord& suggestion)` — computes `(suggestion.root.semitone() - reference.root.semitone() + 12) % 12`, looks up in table, selects upper/lower case based on isUpperCase. Appends chord quality suffix for 7th chords (e.g., "IV7", "ii7"). For tritone interval (6), choose ♯IV or ♭V based on suggestion quality.

    All files use `namespace chordpumper`. Include only standard library headers + existing engine headers.
  </action>
  <verify>All six files compile as part of ChordPumperEngine: `cmake --build build --target ChordPumperEngine 2>&1 | tail -5` shows no errors.</verify>
  <done>PitchClassSet, ScaleDatabase, VoiceLeader, and RomanNumeral all compile. pitchClassSet(C major) produces correct bitmask. voiceLeadingDistance computes distances. romanNumeral returns labeled strings. kAllChords has 108 entries. kModePatterns has 7 modes with correct qualities.</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive Catch2 tests and update CMakeLists.txt</name>
  <files>
    tests/test_pitch_class_set.cpp
    tests/test_voice_leader.cpp
    tests/test_roman_numeral.cpp
    CMakeLists.txt
  </files>
  <action>
    **CMakeLists.txt updates:**
    - Add VoiceLeader.cpp and RomanNumeral.cpp to the ChordPumperEngine static library sources (PitchClassSet.h and ScaleDatabase.h are header-only, no .cpp needed)
    - Add the three new test files to ChordPumperTests executable

    **tests/test_pitch_class_set.cpp:**
    - Test pitchClassSet(): C major → bits 0,4,7 set (value 0x91), F major → bits 0,5,9 set, verify with hex literals
    - Test commonToneCount(): C major vs F major = 1 (C shared), C major vs Am = 2 (C,E shared), C major vs C major = 3
    - Test allChords(): kAllChords.size() == 108, first entry is C Major, last is B HalfDim7, verify no duplicates
    - Test 7th chord sets have 4 bits set, triads have 3 bits set
    - Test enharmonic equivalence: Cs major and Db major produce same PitchClassSet

    **tests/test_voice_leader.cpp:**
    - Test voiceLeadingDistance() with equal-size chords: [60,64,67] to [60,65,69] (C→F close voicing) = 3 (0+1+2)
    - Test voiceLeadingDistance() finds optimal permutation: [60,64,67] to [65,69,60] should still = 3 (not naive sequential)
    - Test optimalVoicing(): C major [60,64,67] → F major should produce voicing near [60,65,69] (not root-pos [65,69,72])
    - Test optimalVoicing() with empty previousNotes returns root-position at given octave
    - Test triad-to-7th chord voice leading handles size mismatch without crash
    - Test transposition invariance: distance(C→F) == distance(D→G) when both are root position triads shifted by 2

    **tests/test_roman_numeral.cpp:**
    - Test all 12 intervals from C major reference: I, ♭II, II, ♭III, III, IV, ♯IV/♭V, V, ♭VI, VI, ♭VII, VII
    - Test case sensitivity: F major from C = "IV" (upper), Dm from C = "ii" (lower)
    - Test 7th chord suffixes: Dm7 from C major = "ii" (or "ii7" depending on implementation)
    - Test from non-C reference: romanNumeral(A major, D major) = "IV"
    - Test augmented/diminished: romanNumeral(C major, E dim) = "iii°" or "iii" (diminished uses lowercase)
    - Test tritone ambiguity: interval 6 from major quality → ♯IV, from diminished quality → ♭v
    - Use GENERATE or SECTION for exhaustive interval coverage
  </action>
  <verify>`cmake --build build --target ChordPumperTests && ctest --test-dir build --output-on-failure -R "pitch_class_set|voice_leader|roman_numeral"` — all new tests pass.</verify>
  <done>All three test files compile and pass. Tests cover: PitchClassSet bitmask construction + common tones + allChords catalog, VoiceLeader distance calculation + optimal voicing + size mismatch + transposition invariance, RomanNumeral all 12 intervals + case sensitivity + non-C references.</done>
</task>

</tasks>

<verification>
1. `cmake --build build --target ChordPumperEngine` compiles with all new sources
2. `cmake --build build --target ChordPumperTests && ctest --test-dir build --output-on-failure` — all tests pass (existing + new)
3. `cmake --build build --target ChordPumper` — plugin still builds with new engine classes
4. No JUCE headers included in any new engine file (verify with grep)
</verification>

<success_criteria>
- 6 new engine files in src/engine/ compile as part of ChordPumperEngine
- 3 new test files pass all assertions
- Existing tests still pass (no regressions)
- Plugin builds successfully with new engine code linked
- Zero JUCE dependency in all new engine files
</success_criteria>

<output>
After completion, create `.planning/phases/04-morphing-suggestions/04-01-SUMMARY.md`
</output>
