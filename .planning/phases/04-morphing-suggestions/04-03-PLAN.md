---
phase: 04-morphing-suggestions
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/ui/PadComponent.h
  - src/ui/PadComponent.cpp
  - src/ui/GridPanel.h
  - src/ui/GridPanel.cpp
autonomous: false
requirements: [GRID-03, GRID-05, GRID-06, CHRD-03]

must_haves:
  truths:
    - "Clicking a pad morphs all 32 pads to show new chord suggestions"
    - "Each pad displays a Roman numeral below the chord name"
    - "The clicked chord is voice-led from the previous voicing (minimal note movement)"
    - "Grid updates atomically — no visible sequential flicker"
    - "User can start from any chord on the chromatic palette and explore freely"
  artifacts:
    - path: "src/ui/PadComponent.h"
      provides: "PadComponent with setRomanNumeral method and romanNumeral display"
      contains: "setRomanNumeral"
    - path: "src/ui/PadComponent.cpp"
      provides: "Paint method rendering both chord name and Roman numeral"
      contains: "romanNumeral"
    - path: "src/ui/GridPanel.h"
      provides: "GridPanel with MorphEngine and VoiceLeader members"
      contains: "MorphEngine"
    - path: "src/ui/GridPanel.cpp"
      provides: "padClicked wiring: voice-lead → MIDI → morph → grid update"
      contains: "morphEngine"
  key_links:
    - from: "src/ui/GridPanel.cpp"
      to: "src/engine/MorphEngine.h"
      via: "morphEngine.morph() called in padClicked"
      pattern: "morphEngine\\.morph"
    - from: "src/ui/GridPanel.cpp"
      to: "src/engine/VoiceLeader.h"
      via: "voiceLeader.optimalVoicing() called in padClicked"
      pattern: "optimalVoicing"
    - from: "src/ui/PadComponent.cpp"
      to: "paint()"
      via: "romanNumeral_ string drawn below chord name"
      pattern: "drawText.*romanNumeral"
---

<objective>
Wire MorphEngine and VoiceLeader into the live UI so clicking a pad voice-leads the chord, sends MIDI, morphs the grid to 32 new suggestions, and displays Roman numerals on every pad.

Purpose: This is the moment the product comes alive — the grid becomes a morphing exploration surface.
Output: Fully functional morph-on-click with Roman numeral labels, ready for user verification.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-morphing-suggestions/04-RESEARCH.md
@.planning/phases/04-morphing-suggestions/04-01-SUMMARY.md
@.planning/phases/04-morphing-suggestions/04-02-SUMMARY.md

@src/ui/PadComponent.h
@src/ui/PadComponent.cpp
@src/ui/GridPanel.h
@src/ui/GridPanel.cpp
@src/engine/MorphEngine.h
@src/engine/VoiceLeader.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Roman numeral display to PadComponent</name>
  <files>
    src/ui/PadComponent.h
    src/ui/PadComponent.cpp
  </files>
  <action>
    **PadComponent.h:**
    - Add `void setRomanNumeral(const std::string& rn);` public method
    - Add `std::string romanNumeral_;` private member
    - Add `#include <string>` if not already present

    **PadComponent.cpp:**
    - Implement `setRomanNumeral`: stores the string and calls repaint()
    - Update `paint()` to render two lines of text when romanNumeral_ is non-empty:
      - Chord name (e.g., "Fmaj7") in the upper portion, font size 14
      - Roman numeral (e.g., "IV") below it in a slightly smaller font (11-12px), using a muted color (e.g., 0xffaaaaaa) to visually distinguish from the chord name
      - When romanNumeral_ is empty (initial chromatic palette state), render chord name centered as before (single line)
    - Use `getLocalBounds().removeFromTop(h/2)` and `removeFromBottom(h/2)` or similar split to position the two text lines. Keep it simple — no complex layout.
    - Ensure Unicode ♭/♯ characters render correctly with the current JUCE font. The default JUCE font supports these. If they render as boxes, fall back to ASCII 'b'/'#'.
  </action>
  <verify>`cmake --build build --target ChordPumper` compiles without errors.</verify>
  <done>PadComponent displays chord name + Roman numeral as two lines. When romanNumeral_ is empty, displays chord name only (backward compatible with chromatic palette).</done>
</task>

<task type="auto">
  <name>Task 2: Wire MorphEngine and VoiceLeader into GridPanel</name>
  <files>
    src/ui/GridPanel.h
    src/ui/GridPanel.cpp
  </files>
  <action>
    **GridPanel.h:**
    - Add `#include "engine/MorphEngine.h"` and `#include "engine/VoiceLeader.h"`
    - Add private members: `MorphEngine morphEngine;` and a way to call VoiceLeader (either as member or use the free function)
    - No other public API changes needed

    **GridPanel.cpp — update padClicked():**
    Replace the current padClicked implementation with this flow:
    1. `releaseCurrentChord();` (existing — stop previous notes)
    2. Voice-lead the clicked chord: `auto voiced = optimalVoicing(chord, activeNotes, defaultOctave);` — if activeNotes is empty (first click), optimalVoicing returns root-position voicing
    3. Send MIDI for the voiced chord: iterate `voiced.midiNotes`, call `keyboardState.noteOn(midiChannel, note, velocity)` for each
    4. Store: `activeNotes.assign(voiced.midiNotes.begin(), voiced.midiNotes.end());`
    5. Start note-off timer: `startTimer(noteDurationMs);`
    6. Morph the grid: `auto suggestions = morphEngine.morph(chord, voiced.midiNotes);`
    7. Batch-update all 32 pads: `for (int i = 0; i < 32; ++i) { pads[i]->setChord(suggestions[i].chord); pads[i]->setRomanNumeral(suggestions[i].romanNumeral); }`
    8. Single repaint: `repaint();` — triggers one

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
  
 
 
 
 
 
 
 paint cycle for the entire grid, avoiding per-pad flicker

    **Important constraints:**
    - Morph runs on the GUI thread (mouseDown handler). This is correct — scoring takes <1ms, well within GUI responsiveness.
    - Do NOT call morph on the audio thread. MIDI goes through MidiKeyboardState which handles thread safety.
    - The VoicedChord from optimalVoicing preserves the Chord identity (root + type) — only the MIDI note octave placement changes.
    - activeNotes now stores voice-led notes (not root-position), so subsequent morphs use the actual voicing for voice-leading scoring.
  </action>
  <verify>`cmake --build build --target ChordPumper` compiles. Load plugin in standalone mode — clicking a pad should morph the grid (all 32 pads change labels).</verify>
  <done>Clicking any pad: (1) voice-leads from previous notes, (2) sends MIDI, (3) morphs grid to 32 suggestions with Roman numerals, (4) grid updates atomically. First click from chromatic palette works (no previous voicing). Subsequent clicks voice-lead from last voicing.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify morph behavior in plugin</name>
  <what-built>Complete morph-on-click flow: voice leading, grid morphing with 32 suggestions, Roman numeral display on every pad.</what-built>
  <how-to-verify>
    1. Build and launch standalone: `cmake --build build && ./build/ChordPumper_artefacts/Standalone/ChordPumper`
    2. Observe initial grid: should show chromatic palette (chord names only, no Roman numerals)
    3. Click any pad (e.g., "C" / C major): grid should morph — all 32 pads update to show new chord names AND Roman numerals below them
    4. Verify Roman numerals make musical sense: clicking C major should show IV (F major), V (G major), vi (A minor) among the suggestions
    5. Click another pad from the morphed grid: grid morphs again relative to the new chord
    6. Verify voice leading: listen for smooth transitions (notes shouldn't jump wildly between octaves)
    7. Check that Unicode ♭/♯ symbols display correctly on pads (not boxes or question marks)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Plugin builds: `cmake --build build --target ChordPumper`
2. All engine tests still pass: `cmake --build build --target ChordPumperTests && ctest --test-dir build --output-on-failure`
3. Standalone launches and grid morphs on click
4. Roman numerals display on all pads after first click
5. No stuck notes, no crashes, no flicker during morph
</verification>

<success_criteria>
- Clicking any pad morphs all 32 pads to contextually related suggestions
- Roman numerals display correctly with proper case (uppercase for major, lowercase for minor)
- Voice-led MIDI output produces smooth transitions
- Initial chromatic palette displays normally (no Roman numerals until first click)
- Grid updates feel instant (no visible sequential redraw)
</success_criteria>

<output>
After completion, create `.planning/phases/04-morphing-suggestions/04-03-SUMMARY.md`
</output>
