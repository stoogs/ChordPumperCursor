---
phase: 04-morphing-suggestions
plan: 02
type: tdd
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/engine/MorphEngine.h
  - src/engine/MorphEngine.cpp
  - tests/test_morph_engine.cpp
  - CMakeLists.txt
autonomous: true
requirements: [GRID-03, GRID-04, GRID-05]

must_haves:
  truths:
    - "108 candidate chords are scored using a weighted composite of diatonic membership, common tones, and voice-leading distance"
    - "Top 32 candidates are selected by descending composite score"
    - "Ionian diatonic chords score highest, modal interchange chords score proportionally lower"
    - "Scoring is transposition-invariant — morph(C major) and morph(D major) produce structurally identical results"
    - "Every played chord is treated as temporary tonic — no persistent key state"
    - "Variety post-filter ensures quality diversity across the 32 suggestions"
  artifacts:
    - path: "src/engine/MorphEngine.h"
      provides: "MorphEngine class with morph() method, MorphWeights struct, ScoredChord struct"
      contains: "MorphEngine"
    - path: "src/engine/MorphEngine.cpp"
      provides: "Scoring implementation: scoreDiatonic, composite scoring loop, top-32 selection"
      min_lines: 60
    - path: "tests/test_morph_engine.cpp"
      provides: "Comprehensive tests for scoring, ranking, transposition invariance, variety"
      min_lines: 60
  key_links:
    - from: "src/engine/MorphEngine.cpp"
      to: "src/engine/PitchClassSet.h"
      via: "commonToneCount for common-tone scoring dimension"
      pattern: "commonToneCount"
    - from: "src/engine/MorphEngine.cpp"
      to: "src/engine/ScaleDatabase.h"
      via: "kModePatterns for diatonic membership scoring"
      pattern: "kModePatterns"
    - from: "src/engine/MorphEngine.cpp"
      to: "src/engine/VoiceLeader.h"
      via: "voiceLeadingDistance for voice-leading scoring dimension"
      pattern: "voiceLeadingDistance"
---

<objective>
Implement the MorphEngine — the heart of ChordPumper's suggestion algorithm. Given a reference chord and current voicing, it scores all 108 candidate chords across three weighted dimensions (diatonic membership, common tones, voice-leading distance), selects the top 32 by composite score, and applies a variety post-filter to ensure quality diversity.

Purpose: This is the product's soul — the engine that makes the grid morph intelligently after each chord click.
Output: Working, tested MorphEngine that produces musically coherent 32-chord suggestion sets.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-morphing-suggestions/04-RESEARCH.md
@.planning/phases/04-morphing-suggestions/04-01-SUMMARY.md

@src/engine/PitchClassSet.h
@src/engine/ScaleDatabase.h
@src/engine/VoiceLeader.h
@src/engine/RomanNumeral.h
@src/engine/Chord.h
@src/engine/ChordType.h
</context>

<feature>
  <name>MorphEngine — Hybrid Chord Scoring and Top-32 Selection</name>
  <files>src/engine/MorphEngine.h, src/engine/MorphEngine.cpp, tests/test_morph_engine.cpp, CMakeLists.txt</files>
  <behavior>
    Given a reference chord and current voicing (MIDI notes), score all 108 chords and return top 32.

    **Scoring dimensions:**
    - Diatonic (weight 0.40): 1.0 for Ionian match, 0.85 Aeolian, 0.80 Mixolydian, 0.75 Dorian, 0.70 Lydian, 0.60 Phrygian/Locrian, 0.0 if no modal match. For each of 7 modes built on the reference root, check if candidate root+quality matches a diatonic degree. Use highest-scoring mode if chord appears in multiple modes.
    - Common tones (weight 0.25): commonToneCount(refSet, candSet) / max(refNoteCount, candNoteCount). Range 0.0–1.0.
    - Voice leading (weight 0.25): 1.0 - (voiceLeadingDistance / maxDistance). maxDistance = 24 (6 semitones × 4 voices). Clamp to 0.0 minimum. Uses root-position target notes for scoring (actual voicing happens at play time, not score time).

    **Variety post-filter:** After scoring and selecting top ~40 candidates, ensure at least 2 chords from each quality category (major-family, minor-family, diminished/augmented, seventh-family). Swap lowest-scoring chords from over-represented categories with highest-scoring from under-represented ones to fill the final 32.

    **Keyless design:** The reference chord IS the tonic. No persistent key variable. Every morph call is self-contained.

    Cases (testable):
    - morph(C major, root-pos voicing).size() == 32
    - morph(C major, ...) → F major, G major, Am are all in the top 10 (strong Ionian relationships)
    - morph(C major, ...) → scoreDiatonic(C root, G major) == 1.0 (V in Ionian)
    - morph(C major, ...) → scoreDiatonic(C root, Eb major) == 0.85 (♭III in Aeolian)
    - morph(C major, ...) → scoreDiatonic(C root, F# major) == 0.0 (not in any mode)
    - Transposition invariance: relative ranking of morph(C major) == morph(D major) when mapped by interval
    - morph(any, ...) includes at least 2 from each quality category (variety filter)
    - Self-chord (reference chord itself) appears in results (high common-tone + zero VL distance)

    **Edge cases:**
    - Symmetric chords (aug/dim7): C aug, E aug, Ab aug have identical pitch class sets. All three may appear (scored by different root intervals), but deduplication by pitch class set prevents more than one from consuming a "slot" in the top 32. Keep the one with the simplest Roman numeral (closest to I).
    - First morph (no previous voicing): voice-leading dimension uses root-position MIDI notes of the reference chord as the comparison baseline.
  </behavior>
  <implementation>
    **MorphEngine.h:**
    - `struct MorphWeights { float diatonic = 0.40f; float commonTones = 0.25f; float voiceLeading = 0.25f; };` (variety is post-filter, not a weight)
    - `struct ScoredChord { Chord chord; float score; std::string romanNumeral; };`
    - `class MorphEngine` with:
      - `MorphWeights weights;` (public, tunable)
      - `std::array<ScoredChord, 32> morph(const Chord& reference, const std::vector<int>& currentVoicing) const;`
      - Private: `float scoreDiatonic(const PitchClass& referenceRoot, const Chord& candidate) const;`

    **MorphEngine.cpp:**
    - `scoreDiatonic()`: iterate kModePatterns[0..6], for each mode iterate 7 degrees, check if `(refSemitone + mode.intervals[degree]) % 12 == candidate.root.semitone()` AND quality matches (triad or seventh). Return score based on mode index (Ionian=1.0, Aeolian=0.85, etc.). Return highest match across all modes. Return 0.0 if no match.
    - `morph()`: build PitchClassSet for reference. For each of kAllChords[0..107]: compute diatonic score, common-tone score (normalized), voice-leading score (inverted+normalized). Compute composite = weighted sum. Also compute romanNumeral string. Store in candidates array. Use `std::partial_sort` to get top ~40 by score. Apply variety post-filter on top 40 to produce final 32. Return `std::array<ScoredChord, 32>`.
    - For voice-leading scoring: compute root-position MIDI notes of each candidate at the same octave as currentVoicing centroid, then call voiceLeadingDistance(currentVoicing, candidateNotes). Normalize: `1.0f - (float(dist) / 24.0f)`, clamp to 0.0f.
    - Variety post-filter: categorize into major-family (Major, Maj7, Dom7), minor-family (Minor, Min7), dim/aug (Diminished, Augmented, Dim7, HalfDim7). If any category has fewer than 2 entries in top 32, swap in the highest-scoring chord from that category (from positions 33-40).

    **CMakeLists.txt:** Add MorphEngine.cpp to ChordPumperEngine sources. Add test_morph_engine.cpp to ChordPumperTests.

    **TDD cycle:** Write tests first (RED), implement to pass (GREEN), refactor if needed.
  </implementation>
</feature>

<verification>
1. `cmake --build build --target ChordPumperTests && ctest --test-dir build --output-on-failure -R "morph_engine"` — all MorphEngine tests pass
2. `ctest --test-dir build --output-on-failure` — ALL tests pass (no regressions)
3. `cmake --build build --target ChordPumper` — plugin still builds
</verification>

<success_criteria>
- MorphEngine::morph() returns exactly 32 ScoredChords for any input chord
- Diatonic chords (IV, V, vi) consistently rank in top 10 for major reference chords
- Transposition invariance holds: morph(C major) and morph(D major) produce equivalent relative rankings
- Variety post-filter ensures at least 2 chords from each quality category
- All tests pass, no regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-morphing-suggestions/04-02-SUMMARY.md`
</output>
