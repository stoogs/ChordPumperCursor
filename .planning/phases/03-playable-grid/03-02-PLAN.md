---
phase: 03-playable-grid
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/PluginProcessor.h
  - src/PluginProcessor.cpp
  - src/ui/GridPanel.h
  - src/ui/GridPanel.cpp
  - src/ui/PluginEditor.h
  - src/ui/PluginEditor.cpp
autonomous: true
requirements: [MIDI-01, MIDI-02]

must_haves:
  truths:
    - "Clicking any pad sends MIDI note-on messages for that chord's notes to downstream instruments"
    - "Notes release automatically after 300ms via Timer-based note-off"
    - "MIDI output uses channel 1, velocity 0.8f, octave 4"
    - "processBlock outputs GUI-triggered MIDI events into the host's MIDI buffer"
    - "Rapid pad clicks release previous chord before triggering new one (no stuck notes)"
  artifacts:
    - path: "src/PluginProcessor.h"
      provides: "MidiKeyboardState member and public getter"
      contains: "MidiKeyboardState"
    - path: "src/PluginProcessor.cpp"
      provides: "processBlock MIDI output via processNextMidiBuffer"
      contains: "processNextMidiBuffer"
    - path: "src/ui/GridPanel.h"
      provides: "Timer inheritance, MIDI wiring members"
      contains: "juce::Timer"
    - path: "src/ui/GridPanel.cpp"
      provides: "padClicked/releaseCurrentChord/timerCallback implementation"
      contains: "noteOn"
  key_links:
    - from: "src/ui/GridPanel.cpp"
      to: "juce::MidiKeyboardState"
      via: "keyboardState.noteOn() in padClicked, keyboardState.noteOff() in releaseCurrentChord"
      pattern: "keyboardState\\.noteOn"
    - from: "src/PluginProcessor.cpp"
      to: "juce::MidiKeyboardState"
      via: "keyboardState.processNextMidiBuffer() in processBlock injects GUI events into output"
      pattern: "processNextMidiBuffer"
    - from: "src/ui/GridPanel.cpp"
      to: "src/engine/Chord.h"
      via: "chord.midiNotes(4) resolves chord to individual MIDI note numbers on GUI thread"
      pattern: "midiNotes"
    - from: "src/ui/PluginEditor.cpp"
      to: "src/PluginProcessor.h"
      via: "processor.getKeyboardState() passed to GridPanel constructor"
      pattern: "getKeyboardState"
---

<objective>
Wire pad clicks to MIDI output so clicking any pad plays that chord through the DAW's instrument chain, satisfying MIDI-01 and MIDI-02.

Purpose: Transform the visual grid from Plan 01 into a playable instrument — the core interaction of ChordPumper.
Output: Updated PluginProcessor (MidiKeyboardState + processBlock MIDI), updated GridPanel (Timer + MIDI wiring), updated PluginEditor (passes keyboard state to grid).
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-playable-grid/03-RESEARCH.md
@.planning/phases/03-playable-grid/03-01-SUMMARY.md

@src/PluginProcessor.h
@src/PluginProcessor.cpp
@src/ui/PluginEditor.h
@src/ui/PluginEditor.cpp
@src/ui/GridPanel.h
@src/ui/GridPanel.cpp
@src/ui/PadComponent.h
@src/engine/Chord.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MidiKeyboardState to PluginProcessor</name>
  <files>
    src/PluginProcessor.h
    src/PluginProcessor.cpp
  </files>
  <action>
    Update `src/PluginProcessor.h`:
    Add private member: `juce::MidiKeyboardState keyboardState;`
    Add public accessor: `juce::MidiKeyboardState& getKeyboardState() { return keyboardState; }`
    (MidiKeyboardState is in juce_audio_basics, already linked.)

    Update `src/PluginProcessor.cpp`:
    In prepareToPlay(): add `keyboardState.reset();` to clear any stale note state.
    In processBlock(): change the signature to accept midiMessages (remove the /*...*/ comment-out).
    Replace body with:
    ```
    buffer.clear();
    midiMessages.clear();
    keyboardState.processNextMidiBuffer(midiMessages, 0, buffer.getNumSamples(), true);
    ```
    The `true` parameter for injectIndirectEvents is CRITICAL — it causes GUI-triggered
    noteOn/noteOff events to appear in the output MidiBuffer. Without it, pad clicks
    produce no MIDI output (see 03-RESEARCH.md Pitfall 1).
    midiMessages.clear() before processNextMidiBuffer prevents passing through any
    incoming MIDI — ChordPumper generates its own MIDI, it doesn't transform input.
  </action>
  <verify>Run `cmake --build build --target ChordPumper_Standalone 2>&1 | tail -5` — compiles cleanly. No functional change yet (no one calls noteOn).</verify>
  <done>PluginProcessor owns MidiKeyboardState, exposes it via getter, processBlock injects GUI-triggered MIDI events into the output buffer.</done>
</task>

<task type="auto">
  <name>Task 2: Wire GridPanel clicks to MIDI output via MidiKeyboardState</name>
  <files>
    src/ui/GridPanel.h
    src/ui/GridPanel.cpp
    src/ui/PluginEditor.h
    src/ui/PluginEditor.cpp
  </files>
  <action>
    Update `src/ui/GridPanel.h`:
    Add `private juce::Timer` to GridPanel's inheritance (multiple inheritance: `public juce::Component, private juce::Timer`).
    Change constructor to `explicit GridPanel(juce::MidiKeyboardState& keyboardState)`.
    Add destructor declaration `~GridPanel() override`.
    Remove the `std::function<void(const Chord&)> onPadClicked` public callback (no longer needed).
    Add private members:
    - `juce::MidiKeyboardState& keyboardState;`
    - `std::vector<int> activeNotes;`
    - `float velocity = 0.8f;`
    - `static constexpr int midiChannel = 1;`
    - `static constexpr int defaultOctave = 4;`
    - `static constexpr int noteDurationMs = 300;`
    Add private method declarations: `void padClicked(const Chord& chord)`, `void releaseCurrentChord()`.
    Add private override: `void timerCallback() override`.

    Update `src/ui/GridPanel.cpp`:
    Change constructor signature to take `juce::MidiKeyboardState& state`, initialize `keyboardState(state)` in member init list.
    Update each pad's onClick lambda to call `padClicked(chord)` directly instead of forwarding to onPadClicked.
    Implement destructor: call `releaseCurrentChord()` to prevent stuck notes on close.
    Implement padClicked(const Chord& chord):
      1. Call releaseCurrentChord() first (release any held chord)
      2. auto notes = chord.midiNotes(defaultOctave)
      3. For each note: keyboardState.noteOn(midiChannel, note, velocity)
      4. activeNotes.assign(notes.begin(), notes.end())
      5. startTimer(noteDurationMs)
    Implement timerCallback():
      1. releaseCurrentChord()
      2. stopTimer()
    Implement releaseCurrentChord():
      1. For each note in activeNotes: keyboardState.noteOff(midiChannel, note, 0.0f)
      2. activeNotes.clear()

    Update `src/ui/PluginEditor.h`:
    No structural changes needed (gridPanel member type unchanged, just constructor arg changes).
    If GridPanel constructor now requires an argument, gridPanel can't be default-constructed.
    Remove default member initialization for gridPanel if present. It will be initialized in the
    constructor's member initializer list.

    Update `src/ui/PluginEditor.cpp`:
    Change constructor's member initializer list: add `gridPanel(p.getKeyboardState())` after `processor(p)`.
    Ensure lookAndFeel is initialized before gridPanel (declaration order in header must be:
    processor, lookAndFeel, gridPanel — C++ initializes in declaration order).
  </action>
  <verify>Run `cmake --build build --target ChordPumper_Standalone 2>&1 | tail -5` — compiles cleanly. Manual verification: load ChordPumper in Bitwig, place a synth instrument downstream in the device chain, click a pad — synth should sound the chord's notes. Alternatively, use MIDI monitor to confirm note-on/note-off messages.</verify>
  <done>Clicking any pad triggers MIDI note-on for all chord tones (channel 1, velocity 0.8, octave 4). Notes auto-release after 300ms via Timer. Previous chord released before new trigger. No stuck notes on rapid clicking or plugin close.</done>
</task>

</tasks>

<verification>
- `cmake --build build --target ChordPumper_Standalone` compiles without errors
- In Bitwig: load ChordPumper as instrument, add a synth after it in the device chain
- Click pad "C" → hear C major chord (C4, E4, G4)
- Click pad "Am" → hear A minor chord (A4, C5, E5), C major releases
- Rapid clicking does not produce stuck notes
- MIDI monitor shows note-on (velocity ~102/127) followed by note-off after ~300ms
- If Bitwig doesn't route IS_SYNTH MIDI downstream: try placing ChordPumper as Note FX before the instrument instead (see 03-RESEARCH.md Open Question 4)
</verification>

<success_criteria>
- Clicking any pad sends correct MIDI note-on messages to plugin output (MIDI-01)
- Note-off messages fire automatically after 300ms (MIDI-02)
- MIDI uses channel 1, velocity 0.8f (≈102/127), octave 4 (MIDI-02)
- No stuck notes during normal operation or plugin teardown
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-playable-grid/03-02-SUMMARY.md`
</output>
