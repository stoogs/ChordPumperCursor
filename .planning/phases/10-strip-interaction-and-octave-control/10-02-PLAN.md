---
phase: 10-strip-interaction-and-octave-control
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - src/ui/ProgressionStrip.h
  - src/ui/ProgressionStrip.cpp
autonomous: true
requirements:
  - STRIP-01
  - STRIP-02
  - STRIP-03
  - STRIP-05

must_haves:
  truths:
    - "Dragging a pad chord over the strip shows accurate drop indicator: insertion line centred in gap, or yellow highlight on target slot"
    - "Dropping a pad chord deposits it at the slot under the cursor — not always appended to the end"
    - "Right-clicking a filled strip slot removes that chord from the strip and repaints"
    - "Filled strip slots display chord name on top line and Roman numeral on bottom line (when non-empty)"
    - "Octave indicator (+/-) visible in strip slot when octaveOffset != 0"
  artifacts:
    - path: "src/ui/ProgressionStrip.h"
      provides: "slotAndGapAtX helper declaration"
      contains: "slotAndGapAtX"
    - path: "src/ui/ProgressionStrip.cpp"
      provides: "Unified hit-test helper, right-click delete, two-line chord+roman rendering, octave indicator"
      contains: "slotAndGapAtX"
  key_links:
    - from: "src/ui/ProgressionStrip.cpp itemDragMove"
      to: "slotAndGapAtX"
      via: "shared hit-test helper"
      pattern: "slotAndGapAtX"
    - from: "src/ui/ProgressionStrip.cpp itemDropped"
      to: "slotAndGapAtX"
      via: "overwriteIndex / insertionIndex set from helper"
      pattern: "slotAndGapAtX"
    - from: "src/ui/ProgressionStrip.cpp paint"
      to: "chord.romanNumeral"
      via: "two-line text draw"
      pattern: "romanNumeral"
---

<objective>
Fix the progression strip's drag-and-drop hit-testing by introducing a unified `slotAndGapAtX()` helper used by both `itemDragMove` and `itemDropped`. Add right-click-to-delete on strip slots. Render Roman numeral second line and octave offset indicator in strip slot paint.

Purpose: STRIP-01 (accurate slot deposit), STRIP-02 (centred indicators), STRIP-03 (delete), STRIP-05 (Roman numeral display) all live in `ProgressionStrip`.
Output: Rewritten hit-testing, right-click delete, two-line slot rendering.
</objective>

<execution_context>
@/home/stoo/.claude/get-shit-done/workflows/execute-plan.md
@/home/stoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-strip-interaction-and-octave-control/10-01-SUMMARY.md
@src/ui/ProgressionStrip.h
@src/ui/ProgressionStrip.cpp
@src/engine/Chord.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unified slotAndGapAtX helper + fix itemDragMove and itemDropped</name>
  <files>src/ui/ProgressionStrip.h, src/ui/ProgressionStrip.cpp</files>
  <action>
**The core bug:** `getChordIndexAtPosition` (used for click) and the inline position math in `itemDragMove` use different boundary calculations, so chords dropped from the grid land at the wrong slot. Fix by extracting one shared helper and using it everywhere.

**Step 1 — Add `slotAndGapAtX` to the private section of `ProgressionStrip.h`:**
```cpp
struct SlotHit { int slotIndex; bool isGap; };
SlotHit slotAndGapAtX(int xPos) const;
```

**Step 2 — Implement `slotAndGapAtX` in `ProgressionStrip.cpp`:**
```cpp
ProgressionStrip::SlotHit ProgressionStrip::slotAndGapAtX(int xPos) const
{
    auto area = getLocalBounds();
    auto slotArea = area.removeFromLeft(area.getWidth() - 120);
    int slotWidth = (slotArea.getWidth() - (kMaxChords - 1) * 4) / kMaxChords;
    int cellWidth = slotWidth + 4;
    int relX = xPos - slotArea.getX();
    relX = juce::jlimit(0, slotArea.getWidth() - 1, relX);
    int cell = relX / cellWidth;
    int posInCell = relX % cellWidth;
    bool inGap = (posInCell >= slotWidth);
    return { juce::jlimit(0, kMaxChords - 1, cell), inGap };
}
```

**Step 3 — Rewrite `itemDragMove` to use `slotAndGapAtX`:**

Replace the entire body of `itemDragMove` with:
```cpp
void ProgressionStrip::itemDragMove(const SourceDetails& details)
{
    auto localPos = getLocalPoint(details.sourceComponent.get(), details.localPosition);
    auto hit = slotAndGapAtX(localPos.getX());

    juce::String desc = details.description.toString();
    int reorderFrom = -1;
    if (desc.startsWith("REORDER:"))
        reorderFrom = desc.fromFirstOccurrenceOf(":", false, false).getIntValue();

    bool isExistingSlot = !hit.isGap && (hit.slotIndex < static_cast<int>(chords.size()));

    if (isExistingSlot && hit.slotIndex != reorderFrom)
    {
        overwriteIndex = hit.slotIndex;
        insertionIndex = -1;
    }
    else
    {
        overwriteIndex = -1;
        // Insertion gap: if in gap after slot N, insert at N+1; if in slot interior, snap to nearest edge
        int gap = hit.isGap ? hit.slotIndex + 1 : hit.slotIndex;
        insertionIndex = juce::jlimit(0, static_cast<int>(chords.size()), gap);
    }
    repaint();
}
```

**Step 4 — Rewrite `insertionIndexAtX` to delegate to `slotAndGapAtX`** (keeps existing callers working):
```cpp
int ProgressionStrip::insertionIndexAtX(int xPos) const
{
    auto hit = slotAndGapAtX(xPos);
    int gap = hit.isGap ? hit.slotIndex + 1 : hit.slotIndex;
    return juce::jlimit(0, static_cast<int>(chords.size()), gap);
}
```

**Step 5 — Ensure `itemDropped` for pad-drops still uses `overwriteIndex`/`insertionIndex` set by `itemDragMove`.** The existing `itemDropped` logic already reads these fields correctly — no changes needed there. Confirm that the pad-drop else-fallback (`addChord`) is still present for the rare case where neither index is valid.
  </action>
  <verify>
`cmake --build build-release --config Release -j$(nproc)` exits 0. Drag a pad chord over each of the 8 strip slots and visually confirm the yellow overwrite highlight lands on the correct slot. Drop confirms the chord appears in the expected position (not always appended at end).
  </verify>
  <done>Build succeeds. Dragging pad over slot 3 highlights slot 3. Dragging over gap between slots 2 and 3 shows insertion line between them. Drop deposits chord at cursor position.</done>
</task>

<task type="auto">
  <name>Task 2: Right-click delete, Roman numeral + octave indicator in strip paint</name>
  <files>src/ui/ProgressionStrip.cpp</files>
  <action>
**Right-click delete (STRIP-03):**

At the very top of `ProgressionStrip::mouseDown`, before the `isReceivingDrag` guard, add:
```cpp
if (event.mods.isPopupMenu())
{
    int idx = getChordIndexAtPosition(event.getPosition());
    if (idx >= 0 && idx < static_cast<int>(chords.size()))
    {
        chords.erase(chords.begin() + idx);
        {
            const juce::ScopedLock sl(stateLock);
            persistentState.progression = chords;
        }
        updateClearButton();
        updateExportButton();
        repaint();
    }
    return;
}
```

**Two-line chord name + Roman numeral rendering (STRIP-05) and octave indicator (STRIP-04):**

In `ProgressionStrip::paint()`, replace the existing single `g.drawText(chords[i].name(), ...)` line (inside the `static_cast<size_t>(i) < chords.size()` branch) with:

```cpp
const auto& c = chords[static_cast<size_t>(i)];
auto chordName = juce::String(c.name());
auto roman     = juce::String(c.romanNumeral);

// Octave indicator: small +/- above chord name when offset is non-zero
if (c.octaveOffset != 0)
{
    juce::String oct = (c.octaveOffset > 0) ? "+" : "-";
    g.setColour(juce::Colour(0xff88aaff));
    g.setFont(juce::Font(juce::FontOptions(8.0f)));
    g.drawText(oct, slot.withHeight(slot.getHeight() / 3),
               juce::Justification::centredTop);
}

if (roman.isEmpty())
{
    g.setColour(juce::Colour(0xffe0e0e0));
    g.setFont(juce::Font(juce::FontOptions(13.0f)));
    g.drawText(chordName, slot, juce::Justification::centred);
}
else
{
    auto topHalf = slot.removeFromTop(slot.getHeight() / 2);
    g.setColour(juce::Colour(0xffe0e0e0));
    g.setFont(juce::Font(juce::FontOptions(11.0f)));
    g.drawText(chordName, topHalf, juce::Justification::centredBottom);
    g.setColour(juce::Colour(0xffaaaaaa));
    g.setFont(juce::Font(juce::FontOptions(9.0f)));
    g.drawText(roman, slot, juce::Justification::centredTop);
}
```

Note: `slot` is used by `removeFromTop` destructively above, so move the overwrite highlight check (which references `slotF`) to before this text block — it already uses `slotF` (the float version) which is computed before `slot` is mutated.

Also update the drag image in `mouseDrag` (the reorder drag) to render chord name + roman numeral in two lines to stay visually consistent:
```cpp
// In the drag image block, replace the single drawText call with:
if (!chords[static_cast<size_t>(index)].romanNumeral.empty())
{
    auto topHalf = juce::Rectangle<int>(0, 0, slotWidth, slotHeight / 2);
    auto botHalf = juce::Rectangle<int>(0, slotHeight / 2, slotWidth, slotHeight / 2);
    imgG.setFont(juce::Font(juce::FontOptions(11.0f)));
    imgG.drawText(juce::String(chords[static_cast<size_t>(index)].name()),
                  topHalf, juce::Justification::centredBottom);
    imgG.setColour(juce::Colour(0xffaaaaaa));
    imgG.setFont(juce::Font(juce::FontOptions(9.0f)));
    imgG.drawText(juce::String(chords[static_cast<size_t>(index)].romanNumeral),
                  botHalf, juce::Justification::centredTop);
}
else
{
    imgG.setFont(juce::Font(juce::FontOptions(13.0f)));
    imgG.drawText(juce::String(chords[static_cast<size_t>(index)].name()),
                  juce::Rectangle<int>(0, 0, slotWidth, slotHeight),
                  juce::Justification::centred);
}
```
  </action>
  <verify>
`cmake --build build-release --config Release -j$(nproc)` exits 0. Then: (1) right-click a filled strip slot and confirm the chord disappears; (2) drag a chord from the grid to the strip after morphing and verify the Roman numeral from the pad appears as a second line in the strip slot.
  </verify>
  <done>Build succeeds. Right-click on a strip slot removes it. Strip slots with Roman numerals show two-line layout (chord name top, Roman numeral bottom). Slots with octaveOffset show a small +/- indicator.</done>
</task>

</tasks>

<verification>
- `cmake --build build-release --config Release -j$(nproc)` exits 0
- Drag pad to strip slot 4: chord appears in slot 4, not slot 8
- Drag over gap between slot 2 and 3: insertion line appears between them
- Right-click slot 2: slot 2 disappears; remaining chords shift left
- Strip slot shows "Cmaj" (top) and "I" (bottom) after morph + drag
- Slot with octaveOffset != 0 shows "+" or "-" indicator
</verification>

<success_criteria>
All four strip requirements addressed: slot-targeted drops (STRIP-01), accurate drop indicators (STRIP-02), right-click delete (STRIP-03), two-line Roman numeral display (STRIP-05). Build clean.
</success_criteria>

<output>
After completion, create `.planning/phases/10-strip-interaction-and-octave-control/10-02-SUMMARY.md`
</output>
