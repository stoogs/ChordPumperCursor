---
phase: 10-strip-interaction-and-octave-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/engine/Chord.h
  - src/PersistentState.cpp
autonomous: true
requirements:
  - STRIP-04
  - STRIP-05

must_haves:
  truths:
    - "Chord struct carries octaveOffset (int, default 0) and romanNumeral (string, default empty)"
    - "Progression chords persisted with octaveOffset and romanNumeral round-trip through toValueTree/fromValueTree"
    - "All existing code compiles unchanged — new fields have zero-initialised defaults"
  artifacts:
    - path: "src/engine/Chord.h"
      provides: "Extended Chord struct with octaveOffset and romanNumeral fields"
      contains: "int octaveOffset = 0"
    - path: "src/PersistentState.cpp"
      provides: "Serialisation of octaveOffset and romanNumeral on progression chord elements"
      contains: "octaveOffset"
  key_links:
    - from: "src/engine/Chord.h"
      to: "src/PersistentState.cpp"
      via: "Chord struct used in progression serialisation"
      pattern: "octaveOffset"
    - from: "src/PersistentState.cpp"
      to: "toValueTree/fromValueTree"
      via: "progression chord child nodes"
      pattern: "c\\.setProperty.*octaveOffset"
---

<objective>
Extend the `Chord` data model with two new zero-default fields (`octaveOffset` and `romanNumeral`) and persist them in the progression section of `PersistentState`.

Purpose: Plans 02 and 03 both depend on these fields existing. Zero-default values mean all existing call sites compile and behave identically to today.
Output: Updated `Chord.h` with two new fields; updated `PersistentState.cpp` serialisation for progression chords.
</objective>

<execution_context>
@/home/stoo/.claude/get-shit-done/workflows/execute-plan.md
@/home/stoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/engine/Chord.h
@src/PersistentState.h
@src/PersistentState.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add octaveOffset and romanNumeral to Chord</name>
  <files>src/engine/Chord.h</files>
  <action>
Add two new fields to the `Chord` struct immediately after `ChordType type;`:

```cpp
int octaveOffset = 0;         // semitone octave shift applied at preview/playback (+1 = up, -1 = down)
std::string romanNumeral;     // Roman numeral label captured at drag time (e.g. "IV", "vi")
```

Both fields have zero/empty defaults so all existing construction sites (aggregate initialisation like `{pitches::C, ChordType::Major}`, `Chord{}`, `Chord{root, type}`) continue to compile and produce a chord with `octaveOffset=0` and empty `romanNumeral`. No other files need changes in this task.
  </action>
  <verify>
`cmake --build build-release --config Release -j$(nproc)` builds with zero errors. No existing files needed changes.
  </verify>
  <done>Build succeeds. `src/engine/Chord.h` contains `int octaveOffset = 0;` and `std::string romanNumeral;` as struct members.</done>
</task>

<task type="auto">
  <name>Task 2: Persist octaveOffset and romanNumeral on progression chords</name>
  <files>src/PersistentState.cpp</files>
  <action>
In `PersistentState::toValueTree()`, inside the `for (const auto& chord : progression)` loop, add two property writes after the existing three (`root`, `accidental`, `type`):

```cpp
c.setProperty("octaveOffset", chord.octaveOffset, nullptr);
c.setProperty("roman",        juce::String(chord.romanNumeral), nullptr);
```

In `PersistentState::fromValueTree()`, inside the progression parsing loop (after the three existing property reads), add:

```cpp
chord.octaveOffset = static_cast<int>(c.getProperty("octaveOffset", 0));
chord.romanNumeral = c.getProperty("roman", "").toString().toStdString();
```

The default values (0 and "") ensure forward and backward compatibility — old state files that lack these properties will default to zero offset and no Roman numeral, which is correct behaviour.
  </action>
  <verify>
`cmake --build build-release --config Release -j$(nproc)` builds with zero errors. Manually inspect the modified section in `PersistentState.cpp` to confirm both fields appear in both `toValueTree` and `fromValueTree`.
  </verify>
  <done>Build succeeds. `PersistentState.cpp` serialises `octaveOffset` and `romanNumeral` on each progression chord child node, and deserialises them back with safe defaults.</done>
</task>

</tasks>

<verification>
- `cmake --build build-release --config Release -j$(nproc)` exits 0
- `src/engine/Chord.h` diff shows exactly two new lines added inside `struct Chord`
- `src/PersistentState.cpp` diff shows `octaveOffset` and `roman` written and read in the progression block
- No other source files modified
</verification>

<success_criteria>
`Chord` carries `octaveOffset` and `romanNumeral` with zero defaults. Progression state persists and restores these fields. All downstream plans (10-02, 10-03) can reference these fields without compilation errors.
</success_criteria>

<output>
After completion, create `.planning/phases/10-strip-interaction-and-octave-control/10-01-SUMMARY.md`
</output>
