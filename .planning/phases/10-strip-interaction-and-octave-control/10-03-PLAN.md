---
phase: 10-strip-interaction-and-octave-control
plan: 03
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - src/ui/PadComponent.h
  - src/ui/PadComponent.cpp
  - src/ui/GridPanel.cpp
  - src/ui/PluginEditor.cpp
autonomous: true
requirements:
  - STRIP-04

must_haves:
  truths:
    - "Right-clicking a pad plays it one octave higher (hold-to-sustain at shifted pitch, note-off on mouse-up)"
    - "Shift+right-clicking a pad plays it one octave lower"
    - "When the chord is dragged after a right-click press, octaveOffset is set on dragChord_ and carried to the strip"
    - "Strip playback of a chord with octaveOffset != 0 plays at the correct shifted octave"
    - "PadComponent no longer exports MIDI on right-click"
  artifacts:
    - path: "src/ui/PadComponent.h"
      provides: "pendingOctaveOffset_ private member"
      contains: "pendingOctaveOffset_"
    - path: "src/ui/PadComponent.cpp"
      provides: "Right-click octave preview replacing MIDI export; octaveOffset carried on dragChord_"
      contains: "pendingOctaveOffset_"
    - path: "src/ui/GridPanel.cpp"
      provides: "startPreview uses chord.octaveOffset to shift preview octave"
      contains: "octaveOffset"
    - path: "src/ui/PluginEditor.cpp"
      provides: "Strip onPressStart uses c.midiNotes(4 + c.octaveOffset)"
      contains: "octaveOffset"
  key_links:
    - from: "src/ui/PadComponent.cpp mouseDown (right-click path)"
      to: "onPressStart callback"
      via: "offsetChord with octaveOffset set"
      pattern: "pendingOctaveOffset_"
    - from: "src/ui/PadComponent.cpp mouseDrag"
      to: "dragChord_.octaveOffset"
      via: "pendingOctaveOffset_ applied before startDragging"
      pattern: "dragChord_\\.octaveOffset"
    - from: "src/ui/GridPanel.cpp startPreview"
      to: "optimalVoicing"
      via: "defaultOctave + chord.octaveOffset"
      pattern: "chord\\.octaveOffset"
    - from: "src/ui/PluginEditor.cpp onPressStart lambda"
      to: "c.midiNotes"
      via: "4 + c.octaveOffset"
      pattern: "octaveOffset"
---

<objective>
Replace the right-click MIDI export on pad with octave-shift hold-to-preview. Right-click holds chord +1 octave; Shift+right-click holds chord -1 octave. The octave offset is carried on `dragChord_` so dragging to the strip preserves it. `GridPanel::startPreview` and `PluginEditor` strip playback both apply the offset.

Purpose: STRIP-04 — octave control on pads with drag persistence to strip.
Output: Updated PadComponent, GridPanel, PluginEditor. MidiFileBuilder right-click export removed from pads.
</objective>

<execution_context>
@/home/stoo/.claude/get-shit-done/workflows/execute-plan.md
@/home/stoo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/10-strip-interaction-and-octave-control/10-01-SUMMARY.md
@src/ui/PadComponent.h
@src/ui/PadComponent.cpp
@src/ui/GridPanel.cpp
@src/ui/GridPanel.h
@src/ui/PluginEditor.cpp
@src/engine/Chord.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: PadComponent right-click octave preview (replace MIDI export)</name>
  <files>src/ui/PadComponent.h, src/ui/PadComponent.cpp</files>
  <action>
**PadComponent.h — add `pendingOctaveOffset_` member:**

In the private section, add after `int pressedQuadrant = -1;`:
```cpp
int pendingOctaveOffset_ = 0;  // set on right-click mouseDown, used in mouseUp/mouseDrag
```

**PadComponent.cpp — replace right-click handler in `mouseDown`:**

Replace the entire `if (event.mods.isPopupMenu())` block (currently exporting MIDI) with:
```cpp
if (event.mods.isPopupMenu())
{
    bool shiftHeld = event.mods.isShiftDown();
    pendingOctaveOffset_ = shiftHeld ? -1 : +1;

    const Chord& baseChord = (hasSubVariations && pressedQuadrant >= 0)
        ? subChords[static_cast<size_t>(pressedQuadrant)]
        : chord;

    Chord offsetChord = baseChord;
    offsetChord.octaveOffset = pendingOctaveOffset_;
    offsetChord.romanNumeral = romanNumeral_;   // carry current label

    isPressed = true;
    isDragInProgress = false;
    repaint();

    if (onPressStart) onPressStart(offsetChord);
    return;
}
```

Note: the `pressedQuadrant` detection line (`pressedQuadrant = quadrantAt(event.getPosition())`) runs for left-click only. Right-click handler returns early before reaching it — `pressedQuadrant` will be -1 for right-click, which is correct (no quadrant context on right-click; use whole pad chord).

**PadComponent.cpp — apply offset in `mouseUp`:**

In `mouseUp`, the existing code builds `activeChord` from `chord` or `subChords`. After the `isDragInProgress` guard (`if (!isDragInProgress)`), a `pendingOctaveOffset_` was set on right-click. `mouseUp` must release the offset preview. Replace the existing `mouseUp` body with:

```cpp
void PadComponent::mouseUp(const juce::MouseEvent& event)
{
    isPressed = false;
    repaint();

    const Chord& baseChord = (hasSubVariations && pressedQuadrant >= 0)
        ? subChords[static_cast<size_t>(pressedQuadrant)]
        : chord;

    if (!isDragInProgress)
    {
        // Build release chord — if right-click pending, use its offset
        Chord releaseChord = baseChord;
        if (pendingOctaveOffset_ != 0)
            releaseChord.octaveOffset = pendingOctaveOffset_;

        if (onPressEnd) onPressEnd(releaseChord);

        // onClick only fires for left-click (pendingOctaveOffset_ == 0 for left-click)
        if (pendingOctaveOffset_ == 0 && event.getDistanceFromDragStart() < 6 && onClick)
            onClick(releaseChord);
    }

    isDragInProgress = false;
    pressedQuadrant = -1;
    pendingOctaveOffset_ = 0;
}
```

**PadComponent.cpp — carry octaveOffset on drag:**

In `mouseDrag`, before `container->startDragging(...)`, set `dragChord_.octaveOffset` and `dragChord_.romanNumeral`:
```cpp
dragChord_ = activeChord;
dragChord_.octaveOffset = pendingOctaveOffset_;  // 0 for left-drag, ±1 for right-drag
dragChord_.romanNumeral = romanNumeral_;          // carry pad's current Roman numeral label
```

Remove the `#include "midi/MidiFileBuilder.h"` include from `PadComponent.cpp` — it is no longer used here. Also remove `#include "midi/MidiFileBuilder.h"` from the includes at the top of `PadComponent.cpp` only if it is not used elsewhere in that file. Verify by checking the file — after removing the right-click export, it is safe to remove.
  </action>
  <verify>
`cmake --build build-release --config Release -j$(nproc)` exits 0. Right-clicking a pad plays the chord (audible note-on); releasing mouse-button stops it (note-off). Shift+right-click plays lower octave.
  </verify>
  <done>Build succeeds. Right-click fires onPressStart with octaveOffset=+1; Shift+right-click fires with octaveOffset=-1. Mouse-up fires onPressEnd. Dragging after right-click sets dragChord_.octaveOffset=+1. No MIDI export on right-click.</done>
</task>

<task type="auto">
  <name>Task 2: Apply octaveOffset in GridPanel::startPreview and PluginEditor strip playback</name>
  <files>src/ui/GridPanel.cpp, src/ui/PluginEditor.cpp</files>
  <action>
**GridPanel.cpp — use chord.octaveOffset in startPreview:**

In `GridPanel::startPreview`, replace:
```cpp
auto voiced = optimalVoicing(chord, activeNotes, defaultOctave);
```
with:
```cpp
auto voiced = optimalVoicing(chord, activeNotes, defaultOctave + chord.octaveOffset);
```

This is the only change needed in GridPanel. `stopPreview` and `morphTo` use `defaultOctave` directly (not `startPreview`) and should not be modified — octave offset only applies to preview hold, not to morph voicing.

**PluginEditor.cpp — use chord.octaveOffset in strip onPressStart:**

In the `progressionStrip.onPressStart` lambda, replace:
```cpp
auto notes = c.midiNotes(4);
```
with:
```cpp
auto notes = c.midiNotes(4 + c.octaveOffset);
```

This ensures that a strip chord which was dragged with an octave offset plays at the correct pitch when held in the strip.
  </action>
  <verify>
`cmake --build build-release --config Release -j$(nproc)` exits 0. Right-click pad, hold, listen: notes are one octave higher than normal left-click. Drag that chord to the strip, then hold-click it in the strip: same octave shift heard.
  </verify>
  <done>Build succeeds. `GridPanel::startPreview` passes `defaultOctave + chord.octaveOffset` to `optimalVoicing`. `PluginEditor` strip playback uses `c.midiNotes(4 + c.octaveOffset)`. Octave shift is end-to-end: pad right-click → hold up octave → drag to strip → strip hold plays same shifted octave.</done>
</task>

</tasks>

<verification>
- `cmake --build build-release --config Release -j$(nproc)` exits 0
- Right-click pad: chord audible at +1 octave; mouse-up stops note
- Shift+right-click pad: chord audible at -1 octave; mouse-up stops note
- Left-click pad: unchanged (no octave shift)
- Drag after right-click to strip: strip slot shows "+" indicator; holding that strip slot plays at +1 octave
- `PadComponent.cpp` no longer includes `midi/MidiFileBuilder.h`
</verification>

<success_criteria>
STRIP-04 fully implemented end-to-end: right-click plays +1 octave, Shift+right-click plays -1 octave, octaveOffset persists through drag to strip and strip playback honours it.
</success_criteria>

<output>
After completion, create `.planning/phases/10-strip-interaction-and-octave-control/10-03-SUMMARY.md`
</output>
