---
phase: 02-chord-engine
plan: 02
type: tdd
wave: 2
depends_on: [02-01]
files_modified:
  - src/engine/PitchClass.h
  - src/engine/PitchClass.cpp
  - tests/test_pitch_class.cpp
autonomous: true
requirements: [CHRD-01, CHRD-02]

must_haves:
  truths:
    - "All 12 canonical pitch classes produce correct semitone values (C=0, C#=1, D=2, Eb=3, E=4, F=5, F#=6, G=7, Ab=8, A=9, Bb=10, B=11)"
    - "PitchClass::name() returns correct display strings for all 12 canonical spellings"
    - "PitchClass::midiNote(octave) returns correct MIDI numbers (C4=60, A4=69, C5=72)"
    - "Enharmonic edge cases handled: Cb→11, Fb→4, B#→0, E#→5"
    - "PitchClass equality distinguishes enharmonic equivalents (C#≠Db by letter+accidental)"
  artifacts:
    - path: "src/engine/PitchClass.h"
      provides: "Working constexpr semitone() implementation"
      contains: "kNaturalSemitones"
    - path: "src/engine/PitchClass.cpp"
      provides: "Working name() and midiNote() implementations"
      min_lines: 15
    - path: "tests/test_pitch_class.cpp"
      provides: "Exhaustive PitchClass tests covering all 12 roots + edge cases"
      min_lines: 50
  key_links:
    - from: "src/engine/PitchClass.h"
      to: "src/engine/NoteLetter.h"
      via: "kNaturalSemitones lookup in semitone()"
      pattern: "kNaturalSemitones\\[static_cast<int>\\(letter\\)\\]"
    - from: "src/engine/PitchClass.cpp"
      to: "src/engine/NoteLetter.h"
      via: "kLetterNames lookup in name()"
      pattern: "kLetterNames\\[static_cast<int>\\(letter\\)\\]"
---

<objective>
Implement PitchClass using test-driven development: semitone arithmetic, display name generation, and MIDI note conversion. PitchClass is the atomic building block for all chord operations — it must correctly represent any note with its enharmonic spelling.

Purpose: TDD ensures the semitone arithmetic and name generation are correct before Chord depends on them. Catching modular arithmetic bugs (Cb, Fb, B#) early prevents cascading failures in chord construction.

Output: Working, tested PitchClass with all methods producing correct results.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-chord-engine/02-RESEARCH.md
@src/engine/NoteLetter.h
@src/engine/PitchClass.h
@src/engine/PitchClass.cpp
@tests/test_pitch_class.cpp
</context>

<feature>
  <name>PitchClass — Note Representation, Semitone Arithmetic, Naming, MIDI Conversion</name>
  <files>tests/test_pitch_class.cpp, src/engine/PitchClass.h, src/engine/PitchClass.cpp</files>
  <behavior>
    PitchClass represents an octave-independent note as NoteLetter + int8_t accidental.

    **semitone() → int (0-11):**
    - C→0, C#→1, D→2, Eb→3, E→4, F→5, F#→6, G→7, Ab→8, A→9, Bb→10, B→11
    - Edge cases with modular arithmetic: Cb→11, Fb→4, B#→0, E#→5, Dbb→0, C##→2
    - Formula: ((kNaturalSemitones[letter] + accidental) % 12 + 12) % 12

    **name() → std::string:**
    - C→"C", Cs→"C#", D→"D", Eb→"Eb", Fs→"F#", Ab→"Ab", Bb→"Bb", B→"B"
    - Double accidentals: {C,2}→"C##", {D,-2}→"Dbb"
    - Natural (accidental=0): no suffix

    **midiNote(octave) → int:**
    - C at octave 4 → 60 (middle C)
    - A at octave 4 → 69
    - C at octave 5 → 72
    - Formula: semitone() + (octave + 1) * 12

    **operator==:**
    - PitchClass{C,0} == PitchClass{C,0} → true
    - PitchClass{C,1} == PitchClass{D,-1} → false (same semitone, different identity)

    **Test structure using GENERATE for all 12 canonical pitches:**
    Test that each of the 12 pitches::X constants produces the expected semitone (0-11).
    Test each name() output individually against expected string.
    Test midiNote() against known values.
    Dedicated section for enharmonic edge cases (Cb, Fb, B#, E#).
  </behavior>
  <implementation>
    **RED phase — write failing tests in tests/test_pitch_class.cpp:**
    Replace the smoke test with comprehensive tests:
    - TEST_CASE "PitchClass semitone values for all 12 canonical pitches" — GENERATE over all 12, check expected semitone
    - TEST_CASE "PitchClass semitone edge cases" — Cb, Fb, B#, E#, Dbb, C##
    - TEST_CASE "PitchClass name generation" — all 12 canonical + double accidentals
    - TEST_CASE "PitchClass MIDI note numbers" — C4=60, A4=69, C5=72, specific edge cases
    - TEST_CASE "PitchClass equality" — same note equal, enharmonic equivalents not equal
    Run tests — they MUST fail (stubs return wrong values).

    **GREEN phase — implement in PitchClass.h and PitchClass.cpp:**
    - Replace stub semitone() in PitchClass.h with:
      `constexpr int semitone() const { int base = kNaturalSemitones[static_cast<int>(letter)]; return ((base + accidental) % 12 + 12) % 12; }`
    - Implement name() in PitchClass.cpp:
      Build string from kLetterNames[letter], append '#' for each positive accidental, 'b' for each negative.
    - Implement midiNote() in PitchClass.cpp:
      `return semitone() + (octave + 1) * 12;`
    Run tests — they MUST all pass.

    **REFACTOR phase (if needed):**
    Clean up any duplication. Ensure const-correctness. No functional changes.
  </implementation>
</feature>

<verification>
1. `cmake --build build/debug --target ChordPumperTests` exits 0
2. `cd build/debug && ctest --output-on-failure` — all PitchClass tests pass
3. Specific spot checks: semitone values 0-11 for canonical 12, midiNote C4=60
4. Edge cases pass: Cb=semitone 11, Fb=semitone 4, B#=semitone 0
</verification>

<success_criteria>
- All PitchClass methods produce correct results for all 12 canonical pitch classes
- Enharmonic edge cases (Cb, Fb, B#, E#, double accidentals) handled correctly
- MIDI note conversion matches standard (C4=60)
- All tests pass via CTest
- PitchClass is ready for Chord to depend on in Plan 02-03
</success_criteria>

<output>
After completion, create `.planning/phases/02-chord-engine/02-02-SUMMARY.md`
</output>
