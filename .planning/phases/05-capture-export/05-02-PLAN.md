---
phase: 05-capture-export
plan: 02
type: execute
wave: 2
depends_on: ["05-01", "05-03"]
files_modified:
  - src/ui/PadComponent.h
  - src/ui/PadComponent.cpp
  - src/ui/PluginEditor.h
  - src/ui/PluginEditor.cpp
autonomous: false
requirements: [CAPT-01]

must_haves:
  truths:
    - "User can drag a pad and a .mid file is created for that chord"
    - "Dragging a pad to the DAW produces a MIDI clip in the arrangement"
    - "Click-to-play still works — short clicks trigger the chord, only drags past threshold initiate DnD"
    - "If Linux embedded DnD fails, user can export .mid to ~/ChordPumper-Export/ and drag from file manager"
    - "Temp files are cleaned up after DnD completes"
  artifacts:
    - path: "src/ui/PadComponent.h"
      provides: "mouseDrag handler for DnD initiation"
      contains: "mouseDrag"
    - path: "src/ui/PadComponent.cpp"
      provides: "DnD logic with distance threshold, MidiFileBuilder call, temp file cleanup"
      contains: "performExternalDragDropOfFiles"
    - path: "src/ui/PluginEditor.h"
      provides: "DragAndDropContainer inheritance for DnD support"
      contains: "DragAndDropContainer"
  key_links:
    - from: "src/ui/PadComponent.cpp"
      to: "src/midi/MidiFileBuilder.h"
      via: "mouseDrag calls createMidiFile to produce the .mid for dragging"
      pattern: "createMidiFile"
    - from: "src/ui/PadComponent.cpp"
      to: "juce::DragAndDropContainer"
      via: "performExternalDragDropOfFiles initiates OS-level file drag"
      pattern: "performExternalDragDropOfFiles"
    - from: "src/ui/PluginEditor.h"
      to: "juce::DragAndDropContainer"
      via: "Editor inherits DragAndDropContainer (required by JUCE DnD)"
      pattern: "DragAndDropContainer"
---

<objective>
Wire drag-and-drop from pad components to the host DAW, with Linux X11 feasibility validation and a file-export fallback. This is the final piece of CAPT-01 — the user drags a pad and a MIDI clip appears in the arrangement.

Purpose: DnD-to-DAW is the core export workflow. Linux X11 embedded DnD is a known risk area — this plan spikes feasibility early and provides a reliable fallback path.
Output: Functional pad-to-DAW drag, click/drag disambiguation, temp file lifecycle management, and ~/ChordPumper-Export/ fallback.
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-capture-export/05-RESEARCH.md
@.planning/phases/05-capture-export/05-01-SUMMARY.md

@src/ui/PadComponent.h
@src/ui/PadComponent.cpp
@src/ui/PluginEditor.h
@src/ui/PluginEditor.cpp
@src/midi/MidiFileBuilder.h
@src/engine/Chord.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire DnD from PadComponent with click/drag disambiguation and fallback export</name>
  <files>src/ui/PadComponent.h, src/ui/PadComponent.cpp, src/ui/PluginEditor.h, src/ui/PluginEditor.cpp</files>
  <action>
    **PluginEditor — inherit DragAndDropContainer:**
    - Add `public juce::DragAndDropContainer` to ChordPumperEditor's inheritance list
    - Include `<juce_gui_basics/juce_gui_basics.h>` if not already included (DragAndDropContainer is in juce_gui_basics, already linked)
    - No other changes to PluginEditor needed for basic DnD support

    **PadComponent — add mouseDrag for DnD initiation:**

    Add to PadComponent.h:
    - `void mouseDrag(const juce::MouseEvent& event) override;`
    - `bool isDragInProgress = false;` private member

    Implement in PadComponent.cpp:
    ```cpp
    void PadComponent::mouseDrag(const juce::MouseEvent& event) {
        // Click/drag disambiguation: only initiate DnD after 6px movement
        if (event.getDistanceFromDragStart() < 6)
            return;

        if (isDragInProgress)
            return;

        auto midiFile = MidiFileBuilder::createMidiFile(chord, 4);
        if (!midiFile.existsAsFile())
            return;

        isDragInProgress = true;
        juce::DragAndDropContainer::performExternalDragDropOfFiles(
            { midiFile.getFullPathName() },
            false,  // canMoveFiles = false (copy semantics)
            this,
            [this, midiFile]() {
                isDragInProgress = false;
                // Delayed cleanup: give DAW 2 seconds to read the file
                juce::Timer::callAfterDelay(2000, [midiFile]() {
                    midiFile.deleteFile();
                });
            }
        );
    }
    ```

    Add `#include "midi/MidiFileBuilder.h"` to PadComponent.cpp.

    **Critical: existing mouseDown behavior is UNCHANGED.** mouseDown still fires onClick (plays the chord). This means clicking AND dragging both trigger the chord sound, but dragging additionally initiates DnD. This is correct behavior — the user hears the chord while dragging it.

    **File-export fallback path:**

    Add a utility method (can be a free function or static method on MidiFileBuilder — use MidiFileBuilder since it already exists):
    - `MidiFileBuilder::exportToDirectory` was defined in 05-01. If the user finds DnD doesn't work in Bitwig, they can use a right-click context menu or keyboard shortcut to export.

    Add right-click export to PadComponent:
    - In mouseDown, check `event.mods.isPopupMenu()` (right-click)
    - If right-click: call `MidiFileBuilder::exportToDirectory(chord, 4, juce::File::getSpecialLocation(juce::File::userHomeDirectory).getChildFile("ChordPumper-Export"))`, show a brief visual flash or tooltip confirming export
    - If left-click: existing onClick behavior (play chord)

    This gives users a reliable export path regardless of whether DnD works in their specific DAW/platform combination.
  </action>
  <verify>
    `cmake --build build` succeeds. Launch Standalone: left-click plays chord (existing behavior), drag past threshold initiates file drag (cursor changes to drag icon), right-click exports .mid to ~/ChordPumper-Export/. Verify temp file cleanup after drag completes.
  </verify>
  <done>PadComponent has click/drag disambiguation. Left-click plays chord. Drag past 6px threshold creates temp .mid and initiates OS-level file drag. Right-click exports to ~/ChordPumper-Export/. Temp files are cleaned up with 2-second delay.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify DnD in Standalone and Bitwig</name>
  <what-built>
    Drag-and-drop from chord pads to external applications, with file-export fallback.
  </what-built>
  <how-to-verify>
    **Test 1 — Standalone DnD (should work):**
    1. Build and launch ChordPumper Standalone
    2. Click a pad — verify chord sound plays (existing behavior intact)
    3. Click and drag a pad to a file manager window or desktop — verify a .mid file appears
    4. Open the .mid in a MIDI player or DAW — verify it contains the correct chord (1 bar duration)

    **Test 2 — Bitwig DnD (feasibility spike):**
    1. Open Bitwig Studio
    2. Load ChordPumper as VST3 or CLAP instrument
    3. Click a pad — verify chord sound plays through downstream instrument
    4. Try dragging a pad to the Bitwig arrangement view
    5. **If it works:** A MIDI clip should appear with the chord notes (1 bar, correct notes)
    6. **If it fails:** Note the error behavior (nothing happens, cursor doesn't change, jassertfalse in console, etc.)

    **Test 3 — Fallback export:**
    1. Right-click any pad in either Standalone or Bitwig
    2. Check ~/ChordPumper-Export/ — a .mid file named after the chord should exist
    3. Drag that .mid from file manager into Bitwig arrangement — verify it imports correctly

    **Expected outcomes:**
    - Test 1: PASS (Standalone uses real top-level window, DnD should work)
    - Test 2: MAY FAIL on Linux X11 embedded plugin — this is the feasibility spike
    - Test 3: PASS (file I/O is reliable, Bitwig accepts .mid from file manager)
  </how-to-verify>
  <resume-signal>
    Report results for all 3 tests. If Test 2 fails, describe behavior. Type "approved" if Test 1 + Test 3 pass (DnD in Bitwig is nice-to-have, fallback is the guaranteed path).
  </resume-signal>
</task>

</tasks>

<verification>
Build succeeds. All three test scenarios evaluated by user. At minimum: Standalone DnD works, right-click export works, exported .mid files contain correct chord data when imported into Bitwig.
</verification>

<success_criteria>
- Left-click on pad plays chord (existing behavior preserved)
- Drag past 6px threshold initiates OS-level file drag with .mid file
- Right-click exports .mid to ~/ChordPumper-Export/ with chord-name filename
- DnD works in Standalone mode
- DnD feasibility in Bitwig evaluated (pass or documented failure)
- File-export fallback works regardless of DnD status
- Temp files cleaned up after DnD (2-second delayed delete)
- No stuck notes, no regression in existing morph/MIDI behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05-capture-export/05-02-SUMMARY.md`
</output>
