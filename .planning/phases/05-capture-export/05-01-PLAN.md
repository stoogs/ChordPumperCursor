---
phase: 05-capture-export
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/midi/MidiFileBuilder.h
  - src/midi/MidiFileBuilder.cpp
  - tests/test_midi_file_builder.cpp
  - CMakeLists.txt
autonomous: true
requirements: [CAPT-01]

must_haves:
  truths:
    - "MidiFileBuilder creates a valid .mid file on disk from any Chord"
    - "MIDI file contains correct note-on and note-off events for all chord tones"
    - "MIDI timestamps produce a one-bar chord clip (1920 ticks at 480 TPQN)"
    - "Tempo meta-event is included (120 BPM) for predictable DAW import"
  artifacts:
    - path: "src/midi/MidiFileBuilder.h"
      provides: "Static createMidiFile and exportToDirectory methods"
      contains: "createMidiFile"
    - path: "src/midi/MidiFileBuilder.cpp"
      provides: "MIDI file creation using juce::MidiFile + MidiMessageSequence"
      contains: "updateMatchedPairs"
    - path: "tests/test_midi_file_builder.cpp"
      provides: "Catch2 tests verifying MIDI file content"
      contains: "TEST_CASE"
  key_links:
    - from: "src/midi/MidiFileBuilder.cpp"
      to: "src/engine/Chord.h"
      via: "Chord::midiNotes(octave) for note data"
      pattern: "midiNotes"
    - from: "tests/test_midi_file_builder.cpp"
      to: "src/midi/MidiFileBuilder.h"
      via: "createMidiFile under test"
      pattern: "createMidiFile"
---

<objective>
TDD implementation of MidiFileBuilder — a utility that converts Chord data into Standard MIDI File (.mid) format on disk. This is the foundational building block for CAPT-01 (drag chord to DAW as MIDI clip).

Purpose: Every export/drag path needs a valid .mid file. Getting the MIDI format right (note-on/off pairing, timestamps in ticks, TPQN, tempo event) is critical — errors produce silent clips, stuck notes, or wrong durations in the DAW.
Output: Tested MidiFileBuilder class with createMidiFile() (temp file for DnD) and exportToDirectory() (named file for fallback export).
</objective>

<execution_context>
@~/.cursor/get-shit-done/workflows/execute-plan.md
@~/.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-capture-export/05-RESEARCH.md

@src/engine/Chord.h
@src/engine/Chord.cpp
@src/engine/PitchClass.h
@src/engine/ChordType.h
@CMakeLists.txt
</context>

<feature>
  <name>MidiFileBuilder: Chord-to-MIDI-file conversion</name>

  <files>src/midi/MidiFileBuilder.h, src/midi/MidiFileBuilder.cpp, tests/test_midi_file_builder.cpp, CMakeLists.txt</files>

  <behavior>
    MidiFileBuilder provides two static methods:

    1. `createMidiFile(const Chord& chord, int octave, float velocity = 0.8f) -> juce::File`
       - Creates a temp .mid file via juce::File::createTempFile(".mid")
       - Returns the File object (caller owns cleanup)

    2. `exportToDirectory(const Chord& chord, int octave, const juce::File& directory, float velocity = 0.8f) -> juce::File`
       - Writes to `directory/{ChordName}.mid` (e.g., `Cmaj.mid`, `Dm7.mid`)
       - Creates directory if it doesn't exist
       - Returns the File object

    Both methods produce an SMF Type 0 file with:
    - 480 ticks per quarter note (TPQN)
    - Tempo meta-event: 120 BPM (500000 microseconds per quarter note)
    - One track containing:
      - Note-on events at timestamp 0 for each chord tone (channel 1, given velocity)
      - Note-off events at timestamp 1920 (= 4 beats = 1 bar in 4/4) for each tone
      - updateMatchedPairs() called after all events added
    - Stream flushed and closed before returning

    Test cases (input -> expected output):
    - C major, octave 4 -> file with 3 note-ons (60, 64, 67), 3 note-offs, TPQN=480
    - Am7, octave 4 -> file with 4 note-ons (57, 60, 64, 67), 4 note-offs
    - Single-note chord (edge) -> file with 1 note-on, 1 note-off
    - Note-on timestamps all == 0.0
    - Note-off timestamps all == 1920.0
    - File exists on disk and is non-empty
    - Tempo meta-event present (120 BPM)
    - exportToDirectory creates directory and writes named file
  </behavior>

  <implementation>
    **CMake setup for JUCE-linked tests:**

    MidiFileBuilder.cpp uses juce::MidiFile, juce::MidiMessageSequence, juce::MidiMessage, juce::File, juce::FileOutputStream — all from juce_audio_basics/juce_core. The test needs to read .mid files back to verify content, which also requires juce_audio_basics.

    Approach: Add MidiFileBuilder.cpp as a source to ChordPumperTests AND add `juce::juce_audio_basics` to ChordPumperTests link libraries. This is the minimal change to enable MIDI file testing. Also add `target_include_directories(ChordPumperTests PRIVATE src)` if not already present. If JUCE module macros cause issues, add `target_compile_definitions(ChordPumperTests PRIVATE JUCE_MODULE_AVAILABLE_juce_audio_basics=1 JUCE_MODULE_AVAILABLE_juce_core=1 JUCE_MODULE_AVAILABLE_juce_events=1)`.

    Also add MidiFileBuilder.cpp to the main ChordPumper plugin target_sources.

    **MidiFileBuilder implementation (GREEN phase):**

    ```cpp
    // src/midi/MidiFileBuilder.h
    #pragma once
    #include "engine/Chord.h"
    #include <juce_audio_basics/juce_audio_basics.h>

    namespace chordpumper {

    class MidiFileBuilder {
    public:
        static juce::File createMidiFile(const Chord& chord, int octave,
                                          float velocity = 0.8f);
        static juce::File exportToDirectory(const Chord& chord, int octave,
                                             const juce::File& directory,
                                             float velocity = 0.8f);
    private:
        static void buildSequence(juce::MidiMessageSequence& seq,
                                   const Chord& chord, int octave, float velocity);
        static bool writeToFile(const juce::MidiMessageSequence& seq,
                                 const juce::File& file);

        static constexpr int kTicksPerQuarterNote = 480;
        static constexpr int kBarLengthTicks = 1920; // 4 beats in 4/4
        static constexpr int kChannel = 1;
        static constexpr int kTempoMicrosecondsPerBeat = 500000; // 120 BPM
    };

    } // namespace chordpumper
    ```

    buildSequence: iterate chord.midiNotes(octave), add noteOn at 0.0, noteOff at 1920.0, add tempo meta-event via MidiMessage::tempoMetaEvent(500000) at timestamp 0.0, call updateMatchedPairs().

    writeToFile: create MidiFile, setTicksPerQuarterNote(480), addTrack(seq), createOutputStream, writeTo, flush (reset stream before return).

    **Test structure (RED phase):**

    Tests use Catch2 + read back the .mid file with juce::MidiFile::readFrom(InputStream&) to verify track count, event count, note numbers, timestamps. Clean up temp files in each test.
  </implementation>
</feature>

<verification>
```bash
cd build && cmake .. -DCHORDPUMPER_BUILD_TESTS=ON && cmake --build . --target ChordPumperTests && ctest --test-dir . -R MidiFileBuilder --output-on-failure
```
All MidiFileBuilder tests pass. Plugin target still builds cleanly.
</verification>

<success_criteria>
- MidiFileBuilder::createMidiFile produces a valid .mid file for any chord type
- Tests verify note count, note numbers, timestamps (0 and 1920), TPQN (480), tempo event
- Tests verify exportToDirectory writes to correct path with chord-name filename
- All existing tests continue to pass
- Plugin builds cleanly (Standalone, VST3, CLAP)
</success_criteria>

<output>
After completion, create `.planning/phases/05-capture-export/05-01-SUMMARY.md`
</output>
